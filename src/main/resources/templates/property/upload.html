<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="common/head::head"></head>

<header th:replace="common/mapHeader::header"></header>
<div class="flex flex-col justify-center items-center h-screen w-screen">
    <h1 class="text-2xl font-bold mb-2">ë“±ê¸°ë¶€ë“±ë³¸ ë¶„ì„</h1>
    <p class="text-sm text-gray-500 mb-4">ì›ë³¸ PDF 1ê°œë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”. (ìµœëŒ€ 20MB)</p>

    <!-- Dropzone -->
    <div id="drop"
         class="flex flex-col justify-center items-center border-2 border-dashed border-gray-300 rounded-xl p-6 bg-white h-[300px] w-[90%]">
        <p class="font-medium text-gray-700">ì—¬ê¸°ì— PDFë¥¼ ëŒì–´ë‹¤ ë†“ê±°ë‚˜</p>
        <p class="text-gray-500">ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ì„ íƒí•˜ì„¸ìš”</p>

        <!-- PDFë§Œ, ë‹¨ì¼ íŒŒì¼ -->
        <input id="file" type="file" name="file" accept="application/pdf" class="hidden"/>

        <div class="flex justify-center gap-3 mt-4">
            <button id="pick" type="button" class="px-4 py-2 rounded-lg bg-gray-800 text-white hover:bg-gray-700">PDF ì„ íƒ
            </button>

        </div>

        <p class="text-xs text-gray-400 mt-2">í—ˆìš© í˜•ì‹: PDF (ìµœëŒ€ 20MB)</p>

        <!-- ë¯¸ë¦¬ë³´ê¸° -->
        <div id="thumbs" class="flex justify-center gap-4 mt-6"></div>
    </div>

    <!-- ë³´ì¦ê¸ˆ, ì›”ì„¸ ë°ì´í„° ë°›ê¸° -->
    <div class="mt-4 flex justify-center gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700">ë³´ì¦ê¸ˆ (ë§Œì›)</label>
            <input id="deposit" type="number"
                   class="w-32 border border-gray-300 bg-white rounded-md px-2 py-1 no-spin
                  focus:border-blue-500 focus:ring-1 focus:ring-blue-500"/>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">ì›”ì„¸ (ë§Œì›)</label>
            <input id="monthlyRent" type="number"
                   class="w-32 border border-gray-300 bg-white rounded-md px-2 py-1 no-spin
                  focus:border-blue-500 focus:ring-1 focus:ring-blue-500"/>
        </div>

    </div>
    <div class="flex justify-center mt-3">
        <button id="upload" type="button" disabled
                class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-500 disabled:opacity-50">
            ë¶„ì„í•˜ê¸°
        </button>
    </div>

</div>

<!-- ë¶„ì„ê²°ê³¼ íŒì—…ì°½ -->
<div id="result-modal"
     class="hidden fixed inset-0 flex items-center justify-center bg-black/30 z-50">
    <div class="bg-white rounded-lg p-6 w-[400px] shadow-lg">
        <div class="flex  mb-3">
            <h3 class="font-bold text-lg">ë¶„ì„ ê²°ê³¼</h3>
            <div class="flex-1"></div>
            <button id="toggleDetail"
                    class="flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-800  text-sm text-white font-medium
         hover:bg-gray-700 active:bg-gray-900 shadow transition duration-200">
                <i class="fa-solid fa-circle-info text-xs "></i>
                ìƒì„¸ë³´ê¸°
            </button>
        </div>
        <!-- ìœ„í—˜ë„ bar + ê¸°ì¤€ ì„ íƒ ë²„íŠ¼ -->
        <div class="mb-3">
            <div class="flex justify-between items-center mb-2">
                <p class="text-sm text-gray-600 font-medium">ìœ„í—˜ë„ ê¸°ì¤€ ì„ íƒ</p>
                <div class="flex gap-2">
                    <button id="btnStatic" class="px-2 py-1 bg-blue-600 text-white rounded text-xs">ê¸°ì¤€ì‹œê°€ ê¸°ì¤€</button>
                    <button id="btnDeal" class="px-2 py-1 bg-gray-300 text-black rounded text-xs">ì‹¤ê±°ë˜ê°€ ê¸°ì¤€</button>
                </div>
            </div>

            <!-- Static bar -->
            <div id="riskBarStaticWrapper" class="w-full bg-gray-200 rounded-full h-4 mb-2 hidden">
                <div id="riskBarStatic" class="h-4 rounded-full"></div>
            </div>

            <!-- Deal bar -->
            <div id="riskBarDealWrapper" class="w-full bg-gray-200 rounded-full h-4 hidden">
                <div id="riskBarDeal" class="h-4 rounded-full"></div>
            </div>
        </div>
        <div class="mt-1 text-lg text-gray-700">
            ìœ„í—˜ë„ ì ìˆ˜: <span id="totalScore"></span> (ë‹¨ê³„: <span id="totalLevel"></span>)
        </div>


        <div id="riskDetail" class="mt-2 hidden">
            ì„ëŒ€ ë¦¬ìŠ¤í¬: <span id="rentRisk"></span><br>
            (ì˜ˆìƒ í‰ê·  ì›”ì„¸ : <span id="rentBase"></span>)<br>
            ë³´ì¦ê¸ˆ ë¦¬ìŠ¤í¬
            <div class="relative inline-block">
                <!-- ? ë²„íŠ¼ -->
                <button class="help-btn w-4 h-4 rounded-full bg-black text-white text-sm flex items-center justify-center"
                        data-tooltip="depositHelpTooltip">
                    ?
                </button>

                <!-- íˆ´íŒ (ê¸°ë³¸ hidden) -->
                <div id="depositHelpTooltip"
                     class="tooltip-box absolute left-1/2 top-full mt-2 w-64 bg-black text-white text-xs
              rounded-lg px-3 py-2 shadow-lg opacity-0 pointer-events-none
              transition transform -translate-x-1/2 z-10">
                    ë³´ì¦ê¸ˆì€ ì¸ê·¼ ìœ ì‚¬ ë©´ì  í‰ê· ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ì‚°ì •ë©ë‹ˆë‹¤.
                </div>
            </div>
            : <span id="depositRisk"></span><br>
            (ì˜ˆìƒ í‰ê·  ë³´ì¦ê¸ˆ : <span id="depositBase"></span>)<br>
            ì±„ê¶Œë³´ì¦ê¸ˆ ë¦¬ìŠ¤í¬
            <div class="relative inline-block">
                <!-- ? ë²„íŠ¼ -->
                <button class="help-btn w-4 h-4 rounded-full bg-black text-white text-sm flex items-center justify-center"
                        data-tooltip="bondHelpTooltip">
                    ?
                </button>

                <!-- íˆ´íŒ (ê¸°ë³¸ hidden) -->
                <div id="bondHelpTooltip"
                     class="tooltip-box absolute left-1/2 top-full mt-2 w-64 bg-black text-white text-xs
              rounded-lg px-3 py-2 shadow-lg opacity-0 pointer-events-none
              transition transform -translate-x-1/2 z-10">
                    ì„¸ì…ìê°€ ë§¡ê¸´ ë³´ì¦ê¸ˆì„ ë²•ì ìœ¼ë¡œ ë³´í˜¸í•˜ê¸° ìœ„í•´ í™˜ì‚°í•œ ê¸ˆì•¡<br>
                    â€œë‚´ ë³´ì¦ê¸ˆì´ ì•ˆì „í•˜ê²Œ íšŒìˆ˜ë  ìˆ˜ ìˆëŠ”ì§€â€ë¥¼ ë”°ì§€ëŠ” ê¸°ì¤€
                </div>
            </div>
            : <span id="bondRisk"></span><br>
            ê·¼ì €ë‹¹ê¶Œ ë¦¬ìŠ¤í¬
            <div class="relative inline-block">
                <!-- ? ë²„íŠ¼ -->
                <button class="help-btn w-4 h-4 rounded-full bg-black text-white text-sm flex items-center justify-center"
                        data-tooltip="debtHelpTooltip">
                    ?
                </button>

                <!-- íˆ´íŒ (ê¸°ë³¸ hidden) -->
                <div id="debtHelpTooltip"
                     class="tooltip-box absolute left-1/2 top-full mt-2 w-64 bg-black text-white text-xs
              rounded-lg px-3 py-2 shadow-lg opacity-0 pointer-events-none
              transition transform -translate-x-1/2 z-10">
                    ì€í–‰ ë“±ì´ ì§‘ì„ ë‹´ë³´ë¡œ ëˆì„ ë¹Œë ¤ì¤„ ë•Œ ì„¤ì •í•˜ëŠ” ê¶Œë¦¬<br>
                    ì±„ë¬´ìê°€ ëˆì„ ëª» ê°šìœ¼ë©´ ì§‘ì„ ê²½ë§¤ë¡œ ë„˜ê²¨ ë¨¼ì € ëˆì„ ë°›ì•„ê°ˆ ìˆ˜ ìˆìŒ
                </div>
            </div>
            : <span id="debtRisk"></span>
        </div>
        <div class="text-right mt-4">
            <button onclick="closeModal()"
                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500">í™•ì¸
            </button>
        </div>
    </div>
</div>


<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40">
    <div class="w-[420px] rounded-xl bg-white p-6 shadow-2xl">
        <h2 class="mb-4 text-lg font-bold">ğŸ“Š ë¶„ì„ ì§„í–‰ì¤‘...</h2>

        <!-- Progress bar wrapper -->
        <div class="w-full overflow-hidden rounded-full bg-gray-200 h-3">
            <!-- ì‹¤ì œ ì§„í–‰ ë§‰ëŒ€ -->
            <div id="progress-bar"
                 class="h-full w-0 bg-blue-500 transition-[width] duration-500 ease-out"></div>
        </div>

        <!-- ì§„í–‰ ë‹¨ê³„ í…ìŠ¤íŠ¸ -->
        <p id="progress-text" class="mt-2 text-sm text-gray-600">ì‹œì‘ ì¤‘...</p>
    </div>
</div>


<!-- ì±—ë´‡ ë¶ˆëŸ¬ì˜¤ê¸° -->
<div th:replace="chatbot/chat::chat"></div>
<style>
    .no-spin::-webkit-inner-spin-button,
    .no-spin::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    .no-spin {
        -moz-appearance: textfield;
    }
</style>

<script>
    // ë²„íŠ¼ í´ë¦­ ì‹œ íˆ´íŒ í† ê¸€
    $(".help-btn").on("click", function (e) {
        e.stopPropagation(); // ë°”ê¹¥ í´ë¦­ ì´ë²¤íŠ¸ë‘ ê²¹ì¹˜ì§€ ì•Šê²Œ
        const tooltipId = $(this).data("tooltip");
        const $tooltip = $("#" + tooltipId);

        $tooltip.toggleClass("opacity-0 pointer-events-none");
    });

    // ë°”ê¹¥ í´ë¦­ ì‹œ ëª¨ë“  íˆ´íŒ ë‹«ê¸°
    $(document).on("click", function (e) {
        $(".tooltip-box").each(function () {
            const $tooltip = $(this);
            const $btn = $(`[data-tooltip='${$tooltip.attr("id")}']`);

            if (!$tooltip.is(e.target) && $tooltip.has(e.target).length === 0 &&
                !$btn.is(e.target) && $btn.has(e.target).length === 0) {
                $tooltip.addClass("opacity-0 pointer-events-none");
            }
        });
    });
</script>

<script>
    const state = {
        totalScoreStatic: 0,
        totalLevelStatic: "",
        totalScoreDeal: 0,
        totalLevelDeal: "",
        resultJson: null
    };


    const depositInput = document.getElementById("deposit");
    const monthlyRentInput = document.getElementById("monthlyRent");
    const uploadBtn = document.getElementById("upload");

    // ì…ë ¥ê°’ ê²€ì‚¬ í•¨ìˆ˜
    function checkInputs() {
        const deposit = depositInput.value.trim();
        const monthlyRent = monthlyRentInput.value.trim();

        if (selectedFile && deposit !== "" && monthlyRent !== "") {
            uploadBtn.disabled = false;
        } else {
            uploadBtn.disabled = true;
        }
    }

    // ì¸í’‹ ì´ë²¤íŠ¸ ë“±ë¡
    depositInput.addEventListener("input", checkInputs);
    monthlyRentInput.addEventListener("input", checkInputs);

    let selectedFile = null;
    const MAX_MB = 20;

    const isPdf = (f) => f && (f.type === "application/pdf" || (f.name || "").toLowerCase().endsWith(".pdf"));

    function showPreview() {
        const thumbs = document.getElementById("thumbs");
        thumbs.innerHTML = "";
        if (!selectedFile) {
            uploadBtn.disabled = true;
            return;
        }
        const sizeMB = (selectedFile.size / (1024 * 1024)).toFixed(2);
        const card = document.createElement("div");
        card.className = "border rounded-lg p-2 bg-white shadow";
        card.innerHTML = `
          <div class="flex items-center gap-3">
            <img src="/images/pdf-icon.png" alt="PDF" class="w-10 h-10">
            <div class="flex-1">
              <p class="text-sm font-medium text-gray-700 truncate">${selectedFile.name}</p>
              <p class="text-xs text-gray-500">${sizeMB} MB</p>
            </div>
          </div>
        `;
        thumbs.appendChild(card);
        checkInputs();
    }

    function setPdf(file) {
        if (!file) {
            selectedFile = null;
            showPreview();
            return;
        }
        if (!isPdf(file)) {
            alert("PDFë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            selectedFile = null;
            showPreview();
            return;
        }
        if (file.size > 20 * 1024 * 1024) {
            alert("íŒŒì¼ì´ 20MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.");
            selectedFile = null;
            showPreview();
            return;
        }
        selectedFile = file;
        showPreview();
    }

    document.getElementById("pick").addEventListener("click", () => document.getElementById("file").click());
    document.getElementById("file").addEventListener("change", function () {
        setPdf(this.files?.[0]);
    });

    const drop = document.getElementById("drop");
    drop.addEventListener("dragenter", e => {
        e.preventDefault();
        drop.classList.add("border-blue-500");
    });
    drop.addEventListener("dragover", e => {
        e.preventDefault();
    });
    drop.addEventListener("dragleave", e => {
        e.preventDefault();
        drop.classList.remove("border-blue-500");
    });

    drop.addEventListener("drop", e => {
        e.preventDefault();
        drop.classList.remove("border-blue-500");
        const file = e.dataTransfer.files?.[0];
        setPdf(file);
    });

    function getRiskClass(level) {
        switch (level) {
            case "ì •ìƒ":
                return "text-green-600 font-bold";
            case "ì£¼ì˜":
                return "text-yellow-600 font-bold";
            case "ìœ„í—˜":
                return "text-orange-600 font-bold";
            case "ê³ ìœ„í—˜":
                return "text-red-600 font-bold";
            default:
                return "text-gray-600";
        }
    }

    // ===================== Progress Animator =====================
    let visualPercent = 0;      // í™”ë©´ì— ë³´ì´ëŠ” í¼ì„¼íŠ¸
    let targetPercent = 0;      // ë‹¨ê³„ë³„ ëª©í‘œ í¼ì„¼íŠ¸
    let progressTimer = null;
    let currentStatusText = "";
    let currentJobId = null;

    const TICK_MS = 80;         // í‹± ê°„ê²©(ms) â†’ ìˆ«ì í‚¤ìš°ë©´ ë” ëŠë ¤ì§
    const SPEED_PER_TICK = 0.4; // í‹±ë‹¹ ì¦ê°€ëŸ‰(%) â†’ ìˆ«ì ì¤„ì´ë©´ ë” ëŠë ¤ì§

    const overlay = document.getElementById("overlay");

    function renderProgressBar() {
        const bar = document.getElementById("progress-bar");
        const label = document.getElementById("progress-text");
        if (bar) bar.style.width = `${visualPercent}%`;
        if (label) label.textContent = currentStatusText || "";
    }

    function setStatusText(text) {
        currentStatusText = text || "";
        renderProgressBar();
    }

    function stopProgress() {
        if (progressTimer) {
            clearInterval(progressTimer);
            progressTimer = null;
        }
    }

    function resetProgress() {
        stopProgress();
        visualPercent = 0;
        targetPercent = 0;
        setStatusText("ì‹œì‘ ì¤‘...");
        const bar = document.getElementById("progress-bar");
        if (bar) bar.style.width = "0%";
    }

    // íƒ€ê²Ÿ í¼ì„¼íŠ¸ë¥¼ ê°±ì‹  (ë’¤ë¡œ ê°€ì§€ ì•Šë„ë¡ ë³´ì¥)
    function setTargetProgress(p) {
        const clamped = Math.max(0, Math.min(100, p));
        targetPercent = Math.max(targetPercent, clamped); // ì—­ì£¼í–‰ ë°©ì§€

        if (!progressTimer) {
            progressTimer = setInterval(() => {
                if (visualPercent < targetPercent) {
                    visualPercent = Math.min(targetPercent, visualPercent + SPEED_PER_TICK);
                    renderProgressBar();
                }
                // ê°™ê±°ë‚˜ í¬ë©´ ëŒ€ê¸° (ê°ì†ŒëŠ” í—ˆìš© ì•ˆ í•¨)
            }, TICK_MS);
        }
    }

    // ë‹¨ê³„ â†’ í…ìŠ¤íŠ¸
    function statusToText(status) {
        return {
            init: "ì‹œì‘ ì¤‘...",
            pdf: "ğŸ“‘ PDF ë¶„ì„ ì¤‘...",
            crawl: "ğŸ  ì‹¤ê±°ë˜ê°€ ì¡°íšŒ ì¤‘...",
            area: "ê³µë™ë§¤ë¬¼ ì§€ì—­ ê²€ìƒ‰ ì¤‘...",
            rent: "í‰ê·  ì›”ì„¸Â·ë³´ì¦ê¸ˆ ì¡°íšŒ ì¤‘...",
            calc: "ğŸ“Š ìœ„í—˜ë„ ê³„ì‚° ì¤‘...",
            collateralValue: "ë‹´ë³´ê°€ì¹˜ ê³„ì‚° ì¤‘...",
            done: "âœ… ì™„ë£Œ",
            error: "âŒ ì˜¤ë¥˜"
        }[status] || "ëŒ€ê¸° ì¤‘...";
    }

    // ë‹¨ê³„ â†’ ëª©í‘œ í¼ì„¼íŠ¸(ê·¸ ë‹¨ê³„ì˜ ìƒí•œì„ )
    function statusToPercent(status) {
        return {
            init: 5,
            pdf: 30,
            crawl: 55,
            area: 65,
            rent: 75,
            calc: 90,
            collateralValue: 95,
            done: 100,
            error: 100
        }[status] ?? 0;
    }

    // ì§„í–‰ë¥ /ë¬¸êµ¬ ê°±ì‹ (ê²Œì´ì§€ëŠ” setIntervalë¡œ ì„œì„œíˆ íƒ€ê²Ÿê¹Œì§€ ì´ë™)
    function updateProgressByStatus(status, percentFromServer) {
        const target = (typeof percentFromServer === "number")
            ? percentFromServer
            : statusToPercent(status);
        setTargetProgress(target);
        setStatusText(statusToText(status));
    }

    // ===================== ì—…ë¡œë“œ ë²„íŠ¼ í•¸ë“¤ëŸ¬ =====================
    document.getElementById("upload").addEventListener("click", async () => {
        const form = new FormData();
        form.append("file", selectedFile);

        const deposit = document.getElementById("deposit").value || 0;
        const monthlyRent = document.getElementById("monthlyRent").value || 0;
        form.append("deposit", deposit);
        form.append("monthlyRent", monthlyRent);

        // Progress ì´ˆê¸°í™” + ì˜¤ë²„ë ˆì´ í‘œì‹œ
        resetProgress();
        overlay.classList.remove("hidden");
        setTargetProgress(5);
        setStatusText("ì‹œì‘ ì¤‘...");

        try {
            const res = await fetch("/usr/property/upload", { method: "POST", body: form });
            const json = await res.json();

            if (!json || !json.ok || !json.jobId) {
                setTargetProgress(100);
                setStatusText("âŒ ì—…ë¡œë“œ ì‘ë‹µ ì˜¤ë¥˜");
                setTimeout(() => { overlay.classList.add("hidden"); stopProgress(); }, 800);
                return;
            }

            currentJobId = json.jobId; // ì¤‘ë³µ í´ë¦­/ì´ì „ job ê°€ë“œìš©
            pollStatus(json.jobId);

        } catch (err) {
            console.error(err);
            setTargetProgress(100);
            setStatusText("âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
            setTimeout(() => { overlay.classList.add("hidden"); stopProgress(); }, 800);
        }
    });

    // ===================== ìƒíƒœ í´ë§ =====================
    async function pollStatus(jobId) {
        // ìµœì‹  jobë§Œ ìœ íš¨
        if (jobId !== currentJobId) return;

        try {
            const res = await fetch(`/usr/property/status/${jobId}`);
            const { status, percent } = await res.json();

            updateProgressByStatus(status, percent);

            if (status === "done") {
                const result = await fetch(`/usr/property/result/${jobId}`).then(r => r.json());
                setStatusText(statusToText("done"));
                setTargetProgress(100);
                setTimeout(() => {
                    overlay.classList.add("hidden");
                    stopProgress();
                    renderResult(result); // â† ì•„ë˜ í•¨ìˆ˜ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                }, 400);
                return;
            }

            if (status === "error") {
                setTargetProgress(100);
                setStatusText(statusToText("error"));
                setTimeout(() => { overlay.classList.add("hidden"); stopProgress(); }, 800);
                return;
            }

            setTimeout(() => pollStatus(jobId), 1000); // 1ì´ˆ ê°„ê²©

        } catch (e) {
            console.error(e);
            setTargetProgress(100);
            setStatusText("âŒ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨");
            setTimeout(() => { overlay.classList.add("hidden"); stopProgress(); }, 800);
        }
    }

    // ===================== ê²°ê³¼ ë Œë”ë§ (ê¸°ì¡´ ë¡œì§ ìœ ì§€) =====================
    function renderResult(result) {
        resultJson = result;

        // íŒì—… ì—´ê¸°
        $("#result-modal").removeClass("hidden");

        function getRiskClass(level) {
            switch (level) {
                case "ì •ìƒ": return "text-green-600 font-bold";
                case "ì£¼ì˜": return "text-yellow-600 font-bold";
                case "ìœ„í—˜": return "text-orange-600 font-bold";
                case "ê³ ìœ„í—˜": return "text-red-600 font-bold";
                default: return "text-gray-600";
            }
        }
        function riskToScore(level) {
            switch (level) {
                case "ì •ìƒ": return 25;
                case "ì£¼ì˜": return 50;
                case "ìœ„í—˜": return 75;
                case "ê³ ìœ„í—˜": return 100;
                default: return 0;
            }
        }
        function scoreToLevel(score) {
            if (score < 40) return "ì •ìƒ";
            else if (score < 60) return "ì£¼ì˜";
            else if (score < 80) return "ìœ„í—˜";
            else return "ê³ ìœ„í—˜";
        }
        function formatMoney(valueInManwon) {
            valueInManwon = parseInt(valueInManwon, 10);
            if (isNaN(valueInManwon)) return "-";
            if (valueInManwon >= 10000) {
                const eok = Math.floor(valueInManwon / 10000);
                const man = valueInManwon % 10000;
                return man === 0 ? `${eok}ì–µ` : `${eok}ì–µ ${man}ë§Œ`;
            } else {
                return `${valueInManwon}ë§Œ`;
            }
        }

        const rentRiskClass = getRiskClass(result.rentRisk);
        const depositRiskClass = getRiskClass(result.depositRisk);
        const bondDepositRiskClass = getRiskClass(result.bondDepositRiskStatic);
        const debtRiskLevelClass = getRiskClass(result.debtRiskLevel);

        const rent = riskToScore(result.rentRisk);
        const deposit = riskToScore(result.depositRisk);
        const bondStatic = riskToScore(result.bondDepositRiskStatic);
        const bondDeal = riskToScore(result.bondDepositRiskDeal);
        const debt = riskToScore(result.debtRiskLevel);

        const totalScoreStatic = (rent + deposit + bondStatic + debt) / 4.0;
        const totalLevelStatic = scoreToLevel(totalScoreStatic);
        const totalScoreDeal = (rent + deposit + bondDeal + debt) / 4.0;
        const totalLevelDeal = scoreToLevel(totalScoreDeal);

        state.totalScoreStatic = totalScoreStatic;
        state.totalLevelStatic = totalLevelStatic;
        state.totalScoreDeal = totalScoreDeal;
        state.totalLevelDeal = totalLevelDeal;
        state.resultJson = result;

        $("#rentRisk").html(`<span class="${rentRiskClass}">${result.rentRisk}</span>`);
        $("#rentBase").html(`<span>${formatMoney(result.avgMonthlyDisplay)}</span>`);
        $("#depositRisk").html(`<span class="${depositRiskClass}">${result.depositRisk}</span>`);
        $("#depositBase").html(`<span>${formatMoney(result.avgDepositDisplay)}</span>`);
        $("#bondRisk").html(`<span class="${bondDepositRiskClass}">${result.bondDepositRisk}</span>`);
        $("#debtRisk").html(`<span class="${debtRiskLevelClass}">${result.debtRiskLevel}</span>`);

        showView("static");
    }


    // ---- ê³µí†µ í•¨ìˆ˜ë“¤ (upload í•¸ë“¤ëŸ¬ ë°”ê¹¥) ----
    function animateBar(selector, score) {
        const $el = $(selector);
        $el.stop(true, true).css("width", "0"); // ì´ì „ ì• ë‹ˆë©”ì´ì…˜ ì •ë¦¬ + ì´ˆê¸°í™”
        $({val: 0}).animate({val: score}, {
            duration: 1500,
            step(now) {
                let color = "#22c55e";
                if (now >= 100) color = "#dc2626";
                else if (now >= 70) color = "#ef4444";
                else if (now >= 50) color = "#eab308";
                $el.css({width: now + "%", backgroundColor: color});
            }
        });
    }

    function updateScoreAndLevel(score, level) {
        $("#totalScore").text(score.toFixed(1));
        $("#totalLevel").html(`<span class="${getRiskClass(level)}">${level}</span>`);
    }

    function updateBondRisk(type, json) {
        if (type === "static") {
            $("#bondRisk").html(
                `<span class="${getRiskClass(json.bondDepositRiskStatic)}">${json.bondDepositRiskStatic}</span>`
            );
        } else {
            $("#bondRisk").html(
                `<span class="${getRiskClass(json.bondDepositRiskDeal)}">${json.bondDepositRiskDeal}</span>`
            );
        }
    }

    function showView(kind) {
        if (kind === "static") {
            $("#riskBarDealWrapper").addClass("hidden");
            $("#riskBarStaticWrapper").removeClass("hidden");
            animateBar("#riskBarStatic", Math.round(state.totalScoreStatic));
            updateScoreAndLevel(state.totalScoreStatic, state.totalLevelStatic);
            updateBondRisk("static", state.resultJson);
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼
            $("#btnStatic").removeClass("bg-gray-300 text-black").addClass("bg-blue-600 text-white");
            $("#btnDeal").removeClass("bg-blue-600 text-white").addClass("bg-gray-300 text-black");
        } else {
            $("#riskBarStaticWrapper").addClass("hidden");
            $("#riskBarDealWrapper").removeClass("hidden");
            animateBar("#riskBarDeal", Math.round(state.totalScoreDeal));
            updateScoreAndLevel(state.totalScoreDeal, state.totalLevelDeal);
            updateBondRisk("deal", state.resultJson);
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼
            $("#btnDeal").removeClass("bg-gray-300 text-black").addClass("bg-blue-600 text-white");
            $("#btnStatic").removeClass("bg-blue-600 text-white").addClass("bg-gray-300 text-black");
        }
    }

    // ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆëŠ” ë‹¨ í•œ ë²ˆë§Œ ë°”ê¹¥ì—!
    $("#btnStatic").on("click", () => showView("static"));
    $("#btnDeal").on("click", () => showView("deal"));


    function closeModal() {
        document.getElementById("result-modal").classList.add("hidden");
    }

    $("#toggleDetail").on("click", function () {
        $("#riskDetail").toggleClass("hidden");

        // ë²„íŠ¼ í…ìŠ¤íŠ¸ í† ê¸€
        if ($("#riskDetail").hasClass("hidden")) {
            $(this).html('<i class="fa-solid fa-circle-info text-xs"></i> ìƒì„¸ë³´ê¸°');
        } else {
            $(this).html('<i class="fa-solid fa-chevron-up text-xs"></i> ì ‘ê¸°');
        }
    });


</script>
</html>
