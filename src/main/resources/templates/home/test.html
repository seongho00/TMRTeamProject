<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="common/head::head"></head> <!-- ✅ 공백 제거 -->


<h2>Firebase Social Login</h2>

<button onclick="googleLogin()">구글 로그인</button>
<button onclick="githubLogin()">깃허브 로그인</button>

<!-- ✅ 모듈 방식으로 수정 -->
<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
        getAuth,
        GoogleAuthProvider,
        GithubAuthProvider,
        signInWithPopup,
        linkWithCredential,
        fetchSignInMethodsForEmail    // ✅ 이거 추가!
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // ✅ Firebase 설정
    const firebaseConfig = {
        apiKey: "AIzaSyDqY-Lj2sJliSi2FOF-nwXf5d99lrlWyMs",
        authDomain: "tmrteamproject.firebaseapp.com",
        projectId: "tmrteamproject",
        storageBucket: "tmrteamproject.firebasestorage.app",
        messagingSenderId: "1042006957683",
        appId: "1:1042006957683:web:7aa5565d3dacc30fda5406",
        measurementId: "G-RE253T3ZQY"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // ✅ Google 로그인
    window.googleLogin = () => {
        const provider = new GoogleAuthProvider();

        // ✅ 항상 계정 선택 창을 띄우기 위한 설정
        provider.setCustomParameters({
            prompt: 'select_account'
        });

        signInWithPopup(auth, provider)
            .then(result => result.user.getIdToken())
            .then(idToken => sendTokenToServer(idToken))
            .catch(console.error);
    };

    // ✅ GitHub 로그인
    window.githubLogin = () => {
        const provider = new GithubAuthProvider();

        signInWithPopup(auth, provider)
            .then(result => result.user.getIdToken())
            .then(idToken => sendTokenToServer(idToken))
            .catch(async (error) => {
                if (error.code === 'auth/account-exists-with-different-credential') {
                    const email = error.customData?.email;
                    const pendingCred = GithubAuthProvider.credentialFromError(error);

                    // 이메일에 연결된 로그인 방식 조회
                    const methods = await fetchSignInMethodsForEmail(auth, email);

                    if (methods.includes('google.com')) {
                        // 기존에 Google로 가입되어 있음 → Google 로그인 시도
                        const googleProvider = new GoogleAuthProvider();
                        googleProvider.setCustomParameters({ prompt: 'select_account' });

                        try {
                            const googleResult = await signInWithPopup(auth, googleProvider);

                            // 병합: 기존 Google 계정에 GitHub credential 연결
                            await linkWithCredential(googleResult.user, pendingCred);

                            const idToken = await googleResult.user.getIdToken();
                            sendTokenToServer(idToken);
                        } catch (e) {
                            console.error("Google 로그인 실패:", e);
                        }
                    } else {
                        console.warn("지원되지 않는 방식:", methods);
                    }
                } else {
                    console.error("기타 로그인 에러:", error);
                }
            });
    };

    // ✅ 서버로 토큰 전송
    function sendTokenToServer(idToken) {
        fetch("http://localhost:8080/usr/member/login-check", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ idToken })  // ✅ 여기에 idToken 추가
        })
            .then(res => res.text())
            .then(console.log)
            .catch(console.error);
    }
</script>