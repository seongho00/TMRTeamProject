<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="common/head::head"></head> <!-- ✅ 공백 제거 -->


<h2>Firebase Social Login</h2>

<button onclick="googleLogin()">구글 로그인</button>
<button onclick="githubLogin()">깃허브 로그인</button>
<button onclick="logout()">로그아웃</button>
<button onclick="checkLoginStatus()">로그인 상태 확인</button>
<button onclick="deleteAccount()">계정 삭제</button>

<!-- ✅ 모듈 방식으로 수정 -->
<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
        getAuth,
        GoogleAuthProvider,
        GithubAuthProvider,
        signInWithPopup,
        linkWithCredential,
        onAuthStateChanged,
        fetchSignInMethodsForEmail
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // ✅ Firebase 설정
    const firebaseConfig = {
        apiKey: "AIzaSyDqY-Lj2sJliSi2FOF-nwXf5d99lrlWyMs",
        authDomain: "tmrteamproject.firebaseapp.com",
        projectId: "tmrteamproject",
        storageBucket: "tmrteamproject.firebasestorage.app",
        messagingSenderId: "1042006957683",
        appId: "1:1042006957683:web:7aa5565d3dacc30fda5406",
        measurementId: "G-RE253T3ZQY"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("✅ 로그인된 사용자:", user.email);
            console.log("🔗 연결된 Provider들:", user.providerData.map(p => p.providerId));
        } else {
            console.log("❌ 로그인 안됨");
        }
    });

    // ✅ Google 로그인
    window.googleLogin = () => {
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({prompt: 'select_account'});

        signInWithPopup(auth, provider)
            .then(async (result) => {
                console.log("result");
                console.log(result);

                // 🔁 병합 정보 확인
                const storedCredJson = sessionStorage.getItem("pendingGithubCred");


                if (storedCredJson) {
                    try {
                        // ✅ 문자열 → 객체로 변환
                        const parsed = JSON.parse(storedCredJson);
                        const accessToken = parsed.accessToken;

                        console.log("parsed : " + storedCred);
                        console.log("accessToken : " + accessToken);

                        if (accessToken) {
                            const pendingCred = GithubAuthProvider.credential(accessToken);
                            await linkWithCredential(result.user, pendingCred);
                            console.log("✅ GitHub 계정 병합 완료");
                        }

                        sessionStorage.removeItem("pendingGithubCred");
                    } catch (e) {
                        console.error("❌ 병합 실패 (파싱 오류):", e);
                    }
                } else {
                    console.log("✅ 병합할 GitHub 정보 없음 → 단순 로그인");
                }

                // ✅ 로그인 성공 → 토큰 전송
                const idToken = await result.user.getIdToken();
                sendTokenToServer(idToken);
            })
            .catch(console.error);
    };


    // ✅ GitHub 로그인
    window.githubLogin = () => {
        const provider = new GithubAuthProvider();
        provider.addScope("user:email");

        signInWithPopup(auth, provider)
            .then(async (result) => {
                const idToken = await result.user.getIdToken();
                sendTokenToServer(idToken);
            })
            .catch(async (error) => {
                if (error.code === "auth/account-exists-with-different-credential") {
                    const pendingCred = GithubAuthProvider.credentialFromError(error);
                    const email = error.customData?.email;

                    if (!email) return;

                    // 👉 병합 정보를 임시 저장
                    sessionStorage.setItem("pendingGithubCred", JSON.stringify(pendingCred));

                    // 👉 Google 로그인 시도 (팝업 또는 버튼 클릭 등)
                    const googleProvider = new GoogleAuthProvider();
                    googleProvider.setCustomParameters({prompt: "select_account"});

                    console.log("googleProvider : " + googleProvider);

                    // ❗ fetchSignInMethodsForEmail 생략 → 직접 로그인 시도
                    const googleResult = await signInWithPopup(auth, googleProvider);
                    console.log("googleResult : " + googleResult);


                    // ✅ 병합 시도
                    const stored = sessionStorage.getItem("pendingGithubCred");
                    console.log("stored : " + stored);
                    if (stored) {
                        const cred = GithubAuthProvider.credentialFromJSON(JSON.parse(stored));
                        await linkWithCredential(googleResult.user, cred);
                        sessionStorage.removeItem("pendingGithubCred");
                        alert("✅ 병합 완료");
                    }
                } else {
                    console.error("🔴 로그인 실패:", error);
                }
            });
    };

    // ✅ 서버로 토큰 전송
    function sendTokenToServer(idToken) {
        fetch("http://localhost:8080/usr/member/login-check", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({idToken})  // ✅ 여기에 idToken 추가
        })
            .then(res => res.text())
            .then(console.log)
            .catch(console.error);
    }

    // ✅ 로그아웃 함수
    window.logout = () => {
        auth.signOut()
            .then(() => {
                alert("로그아웃 되었습니다.");
                console.log("✅ Firebase 로그아웃 완료");
            })
            .catch((error) => {
                console.error("❌ 로그아웃 오류:", error);
                alert("로그아웃 중 오류가 발생했습니다.");
            });
    };

    // ✅ 로그인 상태 확인 버튼 클릭 시 호출
    window.checkLoginStatus = () => {
        onAuthStateChanged(auth, (user) => {
            if (user) {
                alert(`✅ 로그인 상태입니다.\n사용자: ${user.email}`);
                console.log("✅ 로그인됨:", user.email);
            } else {
                alert("❌ 현재 로그인되어 있지 않습니다.");
                console.log("❌ 로그아웃 상태");
            }
        });
    };

    window.deleteAccount = () => {
        const user = auth.currentUser;

        if (user) {
            const confirmDelete = confirm("정말로 계정을 삭제하시겠습니까?\n복구가 불가능합니다.");
            if (!confirmDelete) return;

            user.delete()
                .then(() => {
                    alert("✅ 계정이 성공적으로 삭제되었습니다.");
                    console.log("✅ Firebase 사용자 삭제 완료");
                })
                .catch((error) => {
                    console.error("❌ 계정 삭제 실패:", error);

                    // 🔑 예외: 최근 로그인 필요
                    if (error.code === 'auth/requires-recent-login') {
                        alert("🔐 보안을 위해 최근 로그인 후 다시 시도해주세요.");
                    } else {
                        alert("계정 삭제 중 오류가 발생했습니다.");
                    }
                });
        } else {
            alert("❌ 현재 로그인된 사용자가 없습니다.");
        }
    };

</script>