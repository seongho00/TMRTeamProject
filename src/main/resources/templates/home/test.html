<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="common/head::head"></head> <!-- โ ๊ณต๋ฐฑ ์๊ฑฐ -->


<h2>Firebase Social Login</h2>

<button onclick="googleLogin()">๊ตฌ๊ธ ๋ก๊ทธ์ธ</button>
<button onclick="githubLogin()">๊นํ๋ธ ๋ก๊ทธ์ธ</button>
<button onclick="logout()">๋ก๊ทธ์์</button>
<button onclick="checkLoginStatus()">๋ก๊ทธ์ธ ์ํ ํ์ธ</button>
<button onclick="deleteAccount()">๊ณ์ ์ญ์</button>

<!-- โ ๋ชจ๋ ๋ฐฉ์์ผ๋ก ์์ -->
<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
        getAuth,
        GoogleAuthProvider,
        GithubAuthProvider,
        signInWithPopup,
        linkWithCredential,
        onAuthStateChanged,
        fetchSignInMethodsForEmail
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // โ Firebase ์ค์
    const firebaseConfig = {
        apiKey: "AIzaSyDqY-Lj2sJliSi2FOF-nwXf5d99lrlWyMs",
        authDomain: "tmrteamproject.firebaseapp.com",
        projectId: "tmrteamproject",
        storageBucket: "tmrteamproject.firebasestorage.app",
        messagingSenderId: "1042006957683",
        appId: "1:1042006957683:web:7aa5565d3dacc30fda5406",
        measurementId: "G-RE253T3ZQY"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("โ ๋ก๊ทธ์ธ๋ ์ฌ์ฉ์:", user.email);
            console.log("๐ ์ฐ๊ฒฐ๋ Provider๋ค:", user.providerData.map(p => p.providerId));
        } else {
            console.log("โ ๋ก๊ทธ์ธ ์๋จ");
        }
    });

    // โ Google ๋ก๊ทธ์ธ
    window.googleLogin = () => {
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({prompt: 'select_account'});

        signInWithPopup(auth, provider)
            .then(async (result) => {
                console.log("result");
                console.log(result);

                // ๐ ๋ณํฉ ์๋ณด ํ์ธ
                const storedCredJson = sessionStorage.getItem("pendingGithubCred");


                if (storedCredJson) {
                    try {
                        // โ ๋ฌธ์์ด โ ๊ฐ์ฒด๋ก ๋ณํ
                        const parsed = JSON.parse(storedCredJson);
                        const accessToken = parsed.accessToken;

                        console.log("parsed : " + storedCred);
                        console.log("accessToken : " + accessToken);

                        if (accessToken) {
                            const pendingCred = GithubAuthProvider.credential(accessToken);
                            await linkWithCredential(result.user, pendingCred);
                            console.log("โ GitHub ๊ณ์ ๋ณํฉ ์๋ฃ");
                        }

                        sessionStorage.removeItem("pendingGithubCred");
                    } catch (e) {
                        console.error("โ ๋ณํฉ ์คํจ (ํ์ฑ ์ค๋ฅ):", e);
                    }
                } else {
                    console.log("โ ๋ณํฉํ GitHub ์๋ณด ์์ โ ๋จ์ ๋ก๊ทธ์ธ");
                }

                // โ ๋ก๊ทธ์ธ ์ฑ๊ณต โ ํํฐ ์์ก
                const idToken = await result.user.getIdToken();
                sendTokenToServer(idToken);
            })
            .catch(console.error);
    };


    // โ GitHub ๋ก๊ทธ์ธ
    window.githubLogin = () => {
        const provider = new GithubAuthProvider();
        provider.addScope("user:email");

        signInWithPopup(auth, provider)
            .then(async (result) => {
                const idToken = await result.user.getIdToken();
                sendTokenToServer(idToken);
            })
            .catch(async (error) => {
                if (error.code === "auth/account-exists-with-different-credential") {
                    const pendingCred = GithubAuthProvider.credentialFromError(error);
                    const email = error.customData?.email;

                    if (!email) return;

                    // ๐ ๋ณํฉ ์๋ณด๋ฅผ ์์ ์์ฅ
                    sessionStorage.setItem("pendingGithubCred", JSON.stringify(pendingCred));

                    // ๐ Google ๋ก๊ทธ์ธ ์๋ (ํ์ ๋๋ ๋ฒํผ ํด๋ฆญ ๋ฑ)
                    const googleProvider = new GoogleAuthProvider();
                    googleProvider.setCustomParameters({prompt: "select_account"});

                    console.log("googleProvider : " + googleProvider);

                    // โ fetchSignInMethodsForEmail ์๋ต โ ์ง์ ๋ก๊ทธ์ธ ์๋
                    const googleResult = await signInWithPopup(auth, googleProvider);
                    console.log("googleResult : " + googleResult);


                    // โ ๋ณํฉ ์๋
                    const stored = sessionStorage.getItem("pendingGithubCred");
                    console.log("stored : " + stored);
                    if (stored) {
                        const cred = GithubAuthProvider.credentialFromJSON(JSON.parse(stored));
                        await linkWithCredential(googleResult.user, cred);
                        sessionStorage.removeItem("pendingGithubCred");
                        alert("โ ๋ณํฉ ์๋ฃ");
                    }
                } else {
                    console.error("๐ด ๋ก๊ทธ์ธ ์คํจ:", error);
                }
            });
    };

    // โ ์๋ฒ๋ก ํํฐ ์์ก
    function sendTokenToServer(idToken) {
        fetch("http://localhost:8080/usr/member/login-check", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({idToken})  // โ ์ฌ๊ธฐ์ idToken ์ถ๊ฐ
        })
            .then(res => res.text())
            .then(console.log)
            .catch(console.error);
    }

    // โ ๋ก๊ทธ์์ ํจ์
    window.logout = () => {
        auth.signOut()
            .then(() => {
                alert("๋ก๊ทธ์์ ๋์์ต๋๋ค.");
                console.log("โ Firebase ๋ก๊ทธ์์ ์๋ฃ");
            })
            .catch((error) => {
                console.error("โ ๋ก๊ทธ์์ ์ค๋ฅ:", error);
                alert("๋ก๊ทธ์์ ์ค ์ค๋ฅ๊ฐ ๋ฐ์ํ์ต๋๋ค.");
            });
    };

    // โ ๋ก๊ทธ์ธ ์ํ ํ์ธ ๋ฒํผ ํด๋ฆญ ์ ํธ์ถ
    window.checkLoginStatus = () => {
        onAuthStateChanged(auth, (user) => {
            if (user) {
                alert(`โ ๋ก๊ทธ์ธ ์ํ์๋๋ค.\n์ฌ์ฉ์: ${user.email}`);
                console.log("โ ๋ก๊ทธ์ธ๋จ:", user.email);
            } else {
                alert("โ ํ์ฌ ๋ก๊ทธ์ธ๋์ด ์์ง ์์ต๋๋ค.");
                console.log("โ ๋ก๊ทธ์์ ์ํ");
            }
        });
    };

    window.deleteAccount = () => {
        const user = auth.currentUser;

        if (user) {
            const confirmDelete = confirm("์๋ง๋ก ๊ณ์์ ์ญ์ํ์๊ฒ์ต๋๊น?\n๋ณต๊ตฌ๊ฐ ๋ถ๊ฐ๋ฅํฉ๋๋ค.");
            if (!confirmDelete) return;

            user.delete()
                .then(() => {
                    alert("โ ๊ณ์์ด ์ฑ๊ณต์์ผ๋ก ์ญ์๋์์ต๋๋ค.");
                    console.log("โ Firebase ์ฌ์ฉ์ ์ญ์ ์๋ฃ");
                })
                .catch((error) => {
                    console.error("โ ๊ณ์ ์ญ์ ์คํจ:", error);

                    // ๐ ์์ธ: ์ต๊ทผ ๋ก๊ทธ์ธ ํ์
                    if (error.code === 'auth/requires-recent-login') {
                        alert("๐ ๋ณด์์ ์ํด ์ต๊ทผ ๋ก๊ทธ์ธ ํ ๋ค์ ์๋ํด์ฃผ์ธ์.");
                    } else {
                        alert("๊ณ์ ์ญ์ ์ค ์ค๋ฅ๊ฐ ๋ฐ์ํ์ต๋๋ค.");
                    }
                });
        } else {
            alert("โ ํ์ฌ ๋ก๊ทธ์ธ๋ ์ฌ์ฉ์๊ฐ ์์ต๋๋ค.");
        }
    };

</script>