<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="common/head::head"></head> <!-- โ ๊ณต๋ฐฑ ์๊ฑฐ -->


<h2>Firebase Social Login</h2>

<button onclick="googleLogin()">๊ตฌ๊ธ ๋ก๊ทธ์ธ</button>
<button onclick="githubLogin()">๊นํ๋ธ ๋ก๊ทธ์ธ</button>
<button onclick="logout()">๋ก๊ทธ์์</button>
<button onclick="checkLoginStatus()">๋ก๊ทธ์ธ ์ํ ํ์ธ</button>
<button onclick="deleteAccount()">๊ณ์ ์ญ์</button>

<!-- โ ๋ชจ๋ ๋ฐฉ์์ผ๋ก ์์ -->
<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
        getAuth,
        GoogleAuthProvider,
        GithubAuthProvider,
        signInWithPopup,
        linkWithCredential,
        onAuthStateChanged,
        fetchSignInMethodsForEmail
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // โ Firebase ์ค์
    const firebaseConfig = {
        apiKey: "AIzaSyDqY-Lj2sJliSi2FOF-nwXf5d99lrlWyMs",
        authDomain: "tmrteamproject.firebaseapp.com",
        projectId: "tmrteamproject",
        storageBucket: "tmrteamproject.firebasestorage.app",
        messagingSenderId: "1042006957683",
        appId: "1:1042006957683:web:7aa5565d3dacc30fda5406",
        measurementId: "G-RE253T3ZQY"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("โ ๋ก๊ทธ์ธ๋ ์ฌ์ฉ์:", user.email);
            console.log("๐ ์ฐ๊ฒฐ๋ Provider๋ค:", user.providerData.map(p => p.providerId));
        } else {
            console.log("โ ๋ก๊ทธ์ธ ์๋จ");
        }
    });

    // โ ๊ตฌ๊ธ ๋ก๊ทธ์ธ ํจ์
    // โ Google ๋ก๊ทธ์ธ ํจ์
    window.googleLogin = async () => {
        const provider = new GoogleAuthProvider();

        // ๐ ๊ธฐ๋ณธ ๋ฐ ๋ฏผ๊ฐํ ์๋ณด scope ์ถ๊ฐ
        provider.addScope('profile');
        provider.addScope('email');
        provider.addScope('https://www.googleapis.com/auth/user.phonenumbers.read');

        provider.setCustomParameters({prompt: 'select_account'});

        try {
            const result = await signInWithPopup(auth, provider);

            const user = result.user;
            console.log("โ ๋ก๊ทธ์ธ ์ฑ๊ณต:", user);

            // โ Firebase idToken โ ์๋ฒ ์์ก (์ํ)
            const idToken = await user.getIdToken();
            sendTokenToServer(idToken); // ๋ค๊ฐ ์ด๋ฏธ ๋ง๋ ํจ์๋ผ๊ณ ๊ฐ์

            const token = await user.getIdTokenResult();
            console.log(token.claims);
            console.log(token.signInProvider);
            // โ accessToken โ Google People API ํธ์ถ
            const credential = GoogleAuthProvider.credentialFromResult(result);
            const accessToken = credential.accessToken;

            const profile = await fetchGoogleProfileData(accessToken);

            if (profile) {
                console.log("๐ ์์ ์ด๋ฆ:", profile.name);
                console.log("๐ง ์ด๋ฉ์ผ:", profile.email);
                console.log("๐ ์ํ๋ฒํธ:", profile.phone);
                console.log("๐ผ๏ธ ํ๋กํ ์ด๋ฏธ์ง:", profile.photoUrl);
            }
        } catch (error) {
            console.error("โ ๋ก๊ทธ์ธ ์คํจ:", error);
        }
    };

    async function fetchGoogleProfileData(accessToken) {
        try {
            const response = await fetch(
                "https://people.googleapis.com/v1/people/me?personFields=names,emailAddresses,birthdays,phoneNumbers,photos",
                {
                    headers: {
                        Authorization: `Bearer ${accessToken}`
                    }
                }
            );

            if (!response.ok) {
                throw new Error("Google API ํธ์ถ ์คํจ: " + response.statusText);
            }

            const data = await response.json();
            console.log("โ People API ์๋ต:", data);

            // โ ์ํ๋ ์๋ณด ํ์ฑ
            const name = data.names?.[0]?.displayName || "์ด๋ฆ ์์";
            const email = data.emailAddresses?.[0]?.value || "์ด๋ฉ์ผ ์์";
            const birthday = data.birthdays?.[0]?.date || null;
            const phone = data.phoneNumbers?.[0]?.value || "์ํ๋ฒํธ ์์";
            const photoUrl = data.photos?.[0]?.url || null;

            return {
                name,
                email,
                birthday,
                phone,
                photoUrl
            };
        } catch (err) {
            console.error("โ Google People API ์ค๋ฅ:", err);
            return null;
        }
    }


    // โ ์๋ฒ๋ก ํํฐ ์์ก
    function sendTokenToServer(idToken) {
        fetch("http://localhost:8080/usr/member/login-check", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({idToken})  // โ ์ฌ๊ธฐ์ idToken ์ถ๊ฐ
        })
            .then(res => res.text())
            .then(console.log)
            .catch(console.error);
    }

    // โ ๋ก๊ทธ์์ ํจ์
    window.logout = () => {
        auth.signOut()
            .then(() => {
                alert("๋ก๊ทธ์์ ๋์์ต๋๋ค.");
                console.log("โ Firebase ๋ก๊ทธ์์ ์๋ฃ");
            })
            .catch((error) => {
                console.error("โ ๋ก๊ทธ์์ ์ค๋ฅ:", error);
                alert("๋ก๊ทธ์์ ์ค ์ค๋ฅ๊ฐ ๋ฐ์ํ์ต๋๋ค.");
            });
    };

    // โ ๋ก๊ทธ์ธ ์ํ ํ์ธ ๋ฒํผ ํด๋ฆญ ์ ํธ์ถ
    window.checkLoginStatus = () => {
        onAuthStateChanged(auth, (user) => {
            if (user) {
                alert(`โ ๋ก๊ทธ์ธ ์ํ์๋๋ค.\n์ฌ์ฉ์: ${user.email}`);
                console.log("โ ๋ก๊ทธ์ธ๋จ:", user.email);
            } else {
                alert("โ ํ์ฌ ๋ก๊ทธ์ธ๋์ด ์์ง ์์ต๋๋ค.");
                console.log("โ ๋ก๊ทธ์์ ์ํ");
            }
        });
    };

    window.deleteAccount = () => {
        const user = auth.currentUser;

        if (user) {
            const confirmDelete = confirm("์๋ง๋ก ๊ณ์์ ์ญ์ํ์๊ฒ์ต๋๊น?\n๋ณต๊ตฌ๊ฐ ๋ถ๊ฐ๋ฅํฉ๋๋ค.");
            if (!confirmDelete) return;

            user.delete()
                .then(() => {
                    alert("โ ๊ณ์์ด ์ฑ๊ณต์์ผ๋ก ์ญ์๋์์ต๋๋ค.");
                    console.log("โ Firebase ์ฌ์ฉ์ ์ญ์ ์๋ฃ");
                })
                .catch((error) => {
                    console.error("โ ๊ณ์ ์ญ์ ์คํจ:", error);

                    // ๐ ์์ธ: ์ต๊ทผ ๋ก๊ทธ์ธ ํ์
                    if (error.code === 'auth/requires-recent-login') {
                        alert("๐ ๋ณด์์ ์ํด ์ต๊ทผ ๋ก๊ทธ์ธ ํ ๋ค์ ์๋ํด์ฃผ์ธ์.");
                    } else {
                        alert("๊ณ์ ์ญ์ ์ค ์ค๋ฅ๊ฐ ๋ฐ์ํ์ต๋๋ค.");
                    }
                });
        } else {
            alert("โ ํ์ฌ ๋ก๊ทธ์ธ๋ ์ฌ์ฉ์๊ฐ ์์ต๋๋ค.");
        }
    };

</script>