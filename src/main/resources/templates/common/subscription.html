<!-- [5] 공통 레이아웃(예: mainHeader.html 아래쪽 또는 공통 footer)에 팝업 마크업/스크립트 추가 -->
<!-- 주석: 로그인 여부를 서버에서 알려주는 전역 플래그. 프로젝트 상황에 맞게 수정 -->
<script th:inline="javascript">
    /*<![CDATA[*/
    window.IS_LOGIN = /*[[${#request.remoteUser != null}]]*/ false; // 시큐리티/세션 환경에 맞게 수정
    /*]]>*/
</script>

<!-- 팝업 모달 -->
<div id="due-alert-modal" class="fixed inset-0 z-[1000] hidden">
    <!-- 오버레이 -->
    <div class="absolute inset-0 bg-black/50" onclick="hideDueAlertModal()"></div>

    <!-- 카드 -->
    <div class="relative mx-auto mt-24 w-[560px] max-w-[92vw] rounded-2xl bg-white shadow-lg">
        <div class="px-6 py-4 border-b flex items-center justify-between">
            <h3 class="text-lg font-semibold">청약 알림</h3>
            <button type="button" class="text-gray-500 hover:text-black" onclick="hideDueAlertModal()">✕</button>
        </div>
        <div id="due-alert-list" class="max-h-[60vh] overflow-auto px-6 py-4 space-y-3">
            <!-- 항목이 동적으로 렌더링됨 -->
        </div>
        <div class="px-6 py-3 border-t flex items-center justify-between">
            <label class="inline-flex items-center gap-2 text-sm text-gray-600">
                <input id="dont-show-today" type="checkbox" class="h-4 w-4">
                오늘 하루 보지 않기
            </label>
            <div class="flex gap-2">
                <button type="button" class="px-4 py-2 border rounded" onclick="hideDueAlertModal()">닫기</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 주석: 오늘 날짜 문자열(로컬) 생성
    function todayKey() {
        const d = new Date();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${d.getFullYear()}-${mm}-${dd}`;
    }

    // 주석: 팝업 표시/숨김
    function showDueAlertModal() {
        document.getElementById('due-alert-modal')?.classList.remove('hidden');
        document.documentElement.classList.add('overflow-hidden');
    }

    function hideDueAlertModal() {
        const dont = document.getElementById('dont-show-today')?.checked;
        if (dont) {
            localStorage.setItem('lhDueAlert.hideDate', todayKey());
        }
        document.getElementById('due-alert-modal')?.classList.add('hidden');
        document.documentElement.classList.remove('overflow-hidden');
    }

    // 주석: 항목 렌더링
    function renderDueAlerts(items) {
        const box = document.getElementById('due-alert-list');
        if (!box) return;
        if (!items || items.length === 0) {
            box.innerHTML = '<div class="text-center text-gray-500 py-6">오늘 기준으로 도착한 알림이 없어.</div>';
            return;
        }
        box.innerHTML = items.map(it => `
            <div class="rounded-lg border p-3 flex items-start justify-between gap-3">
            <div>
            <div class="font-medium">${escapeHtml(it.name || '')}</div>
            <div class="text-sm text-gray-600">
            신청 시작: ${formatDateTime(it.applyStart)} ·
            ${badge(it.daysUntil)}
            </div>
            </div>
            <form method="post" action="/usr/sms/interest/cancel" class="shrink-0">
            <input type="hidden" name="scheduleId" value="${it.scheduleId}">
            <button type="submit" class="px-3 py-1.5 border rounded text-red-600 border-red-300 text-sm">해제</button>
            </form>
            </div>
        `).join('');
    }

    // 주석: 보조 함수들
    function badge(days) {
        if (days === 0) return '<span class="inline-block px-2 py-0.5 rounded bg-red-100 text-red-700 text-xs">당일</span>';
        if (days === 1) return '<span class="inline-block px-2 py-0.5 rounded bg-orange-100 text-orange-700 text-xs">D-1</span>';
        if (days === 7) return '<span class="inline-block px-2 py-0.5 rounded bg-blue-100 text-blue-700 text-xs">D-7</span>';
        return '';
    }

    function formatDateTime(iso) {
        try {
            const d = new Date(iso);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const hh = String(d.getHours()).padStart(2, '0');
            const mm = String(d.getMinutes()).padStart(2, '0');
            return `${y}-${m}-${day} ${hh}:${mm}`;
        } catch (e) {
            return iso;
        }
    }

    function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, m => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        })[m]);
    }

    // 주석: 로그인했고 오늘 "보지 않기" 설정이 아니면 서버에서 알림을 로드해서 팝업으로 띄워줘
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            if (!window.IS_LOGIN) return; // 로그인 안 했으면 표시 안 함
            const hideDate = localStorage.getItem('lhDueAlert.hideDate');
            if (hideDate === todayKey()) return; // 오늘은 표시 안 함

            const res = await fetch('/usr/sms/alerts/due', {headers: {'Accept': 'application/json'}});
            if (!res.ok) return;
            const items = await res.json();
            if (Array.isArray(items) && items.length > 0) {
                renderDueAlerts(items);
                showDueAlertModal();
            }
        } catch (e) {
            // 에러는 조용히 무시
        }
    });
</script>
