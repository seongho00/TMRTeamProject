<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="common/head::head"></head> <!-- âœ… ê³µë°± ì œê±° -->

<script>
    function showChatBot() {
        $(".chatbot").toggleClass('hidden');
    }

    function sendMessage() {
        let message = $("#chatbotText").val();
        const $chatBox = $("#chat-box");
        $.ajax({
            type: "POST",
            url: "sendMessage",
            data: {message: message},
            success: function (data) {
                if (data.resultCode === "F-3") {
                    const candidates = data.data1;

                    // ê¸°ì¡´ í‘œì‹œ ì˜ì—­ ë¹„ìš°ê¸°
                    $("#candidateContainer").empty();

                    // ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
                    $("#candidateContainer").append(
                        `<p>${data.msg || "ë™ ì´ë¦„ì´ ì—¬ëŸ¬ êµ¬ì— ìˆì–´ìš”. ì •í™•í•œ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”."}</p>`
                    );

                    // í›„ë³´ ë²„íŠ¼ ìƒì„±
                    candidates.forEach(function (c) {
                        const label = [c.sidoNm, c.sggNm, c.emdNm ?? c.emd].filter(Boolean).join(" ");

                        $("<button>")
                            .text(label)
                            .addClass("candidate-btn")
                            .on("click", function () {
                                // í˜„ì¬ success ìŠ¤ì½”í”„ì˜ messageëŠ” ë°”ê¹¥ ë³€ìˆ˜ë¼ í˜¼ë™ë  ìˆ˜ ìˆìœ¼ë‹ˆ ìƒˆë¡œ êµ¬ì„±
                                const newMessage = $("#chatbotText").val() + " " + c.sggNm;

                                // ì…ë ¥ì°½ ì—…ë°ì´íŠ¸ í›„ ì¬í˜¸ì¶œ
                                $("#chatbotText").val(newMessage);
                                $("#candidateContainer").empty();   // í›„ë³´ UI ì •ë¦¬
                                sendMessage();                      // âœ… ê¸°ì¡´ í•¨ìˆ˜ ì¬ì‚¬ìš©
                            })
                            .appendTo("#candidateContainer");
                    });
                    return;
                }
                console.log(data)
                const flaskResult = data.data1;
                const populationSummary = data.data2;
                const sido = flaskResult.sido;
                const sigungu = flaskResult.sigungu;
                const emd = flaskResult.emd;

                console.log(sido);
                console.log(sigungu);
                console.log(emd);

                const regionText = [sido, sigungu, emd]
                    .filter(val => val && val !== "")
                    .join(" ");
                // ë°ì´í„° ê°€ì ¸ì™€ì„œ ì§€ì—­ë„ ë³´ì—¬ì£¼ê¸°

                if (flaskResult.gender === "" && flaskResult.ageGroup === "") {
                    // ì„±ë³„ë„ ì—†ê³ , ë‚˜ì´ëŒ€ë„ ì—†ì„ ë•Œ â†’ ì „ì²´ ì¸êµ¬ ì¶œë ¥
                    $chatBox.append(`<div class="bot-msg"><b>ì±—ë´‡:</b> ${regionText}ì˜ ì „ì²´ ìœ ë™ì¸êµ¬ëŠ” ${populationSummary.total}ëª…ì…ë‹ˆë‹¤.</div>`);
                } else if (flaskResult.gender !== "" && flaskResult.ageGroup === "") {
                    // ì„±ë³„ë§Œ ìˆì„ ë•Œ
                    const genderKor = flaskResult.gender === "male" ? "ë‚¨ì„±" : "ì—¬ì„±";
                    const genderValue = flaskResult.gender === "male" ? populationSummary.male : populationSummary.female;

                    $chatBox.append(`<div class="bot-msg"><b>ì±—ë´‡:</b> ${regionText}ì˜ ${genderKor} ìœ ë™ì¸êµ¬ëŠ” ${genderValue}ëª…ì…ë‹ˆë‹¤.</div>`);
                } else if (flaskResult.gender === "" && flaskResult.ageGroup !== "") {
                    // ë‚˜ì´ëŒ€ë§Œ ìˆì„ ë•Œ
                    const convertAgeKey = (ageGroup) => ageGroup?.replace("age_", "age");

                    const ageGroupMap = {
                        "age_10": "10ëŒ€",
                        "age_20": "20ëŒ€",
                        "age_30": "30ëŒ€",
                        "age_40": "40ëŒ€",
                        "age_50": "50ëŒ€",
                        "age_60": "60ëŒ€"
                    };

                    const rawAgeGroup = flaskResult.ageGroup;         // ì˜ˆ: "age_20"
                    const ageKor = ageGroupMap[rawAgeGroup];          // ì˜ˆ: "20ëŒ€"
                    const ageKey = convertAgeKey(rawAgeGroup);        // ì˜ˆ: "age20"
                    const ageValue = populationSummary?.[ageKey];     // ì˜¬ë°”ë¥´ê²Œ ì ‘ê·¼

                    $chatBox.append(`<div class="bot-msg"><b>ì±—ë´‡:</b> ${regionText}ì˜ ${ageKor} ìœ ë™ì¸êµ¬ëŠ” ${ageValue}ëª…ì…ë‹ˆë‹¤.</div>`);
                } else {
                    // ì„±ë³„ + ë‚˜ì´ëŒ€ ëª¨ë‘ ìˆì„ ë•Œ â†’ ì¡°í•© ë°ì´í„°ëŠ” ì—†ìœ¼ë¯€ë¡œ ë”°ë¡œ ì•ˆë‚´
                    const genderKor = flaskResult.gender === "male" ? "ë‚¨ì„±" : "ì—¬ì„±";
                    const genderValue = flaskResult.gender === "male" ? populationSummary.male : populationSummary.female;

                    const convertAgeKey = (ageGroup) => ageGroup?.replace("age_", "age");

                    const ageGroupMap = {
                        "age10": "10ëŒ€",
                        "age20": "20ëŒ€",
                        "age30": "30ëŒ€",
                        "age40": "40ëŒ€",
                        "age50": "50ëŒ€",
                        "age60": "60ëŒ€"
                    };

                    const ageKey = convertAgeKey(flaskResult.ageGroup);  // "age_20" â†’ "age20"
                    const ageKor = ageGroupMap[ageKey];
                    const ageValue = populationSummary?.[ageKey];

                    console.log("flaskResult.ageGroup:", flaskResult.ageGroup);
                    console.log("ë³€í™˜ëœ ageKey:", ageKey);
                    console.log("ageKor:", ageKor);
                    console.log("populationSummary keys:", Object.keys(populationSummary));

                    $chatBox.append(`<div class="bot-msg"><b>ì±—ë´‡:</b>"${regionText}ì˜ ${ageKor} ${genderKor}"ì— ëŒ€í•œ ì •í™•í•œ ì¸êµ¬ìˆ˜ëŠ” ì œê³µë˜ì§€ ì•Šì§€ë§Œ,<br>
                    ê°ê°ì˜ í†µê³„ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤ ğŸ˜Š <br>
                    ğŸ‘‰ ${ageKor} ì¸êµ¬: ${ageValue}ëª…<br>
                    ğŸ‘‰ ${genderKor} ì¸êµ¬: ${genderValue}ëª…</div>`);
                }

                $("#chatbotText").val("");  // ì…ë ¥ì°½ ë¹„ìš°ê¸°
                $chatBox.scrollTop($chatBox[0].scrollHeight); // ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ
            },
            error: function () {
                $chatBox.append(`<div class="bot-msg"><b>ì±—ë´‡:</b> ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`);
            }
        });
    }
</script>
<style>
    .candidate-btn {
        display: block;
        width: 500px;
        padding: 10px 14px;
        margin-bottom: 8px;
        text-align: left;
        border: 1px solid #d1d5db; /* íšŒìƒ‰ í…Œë‘ë¦¬ */
        border-radius: 8px;
        background-color: white;
        color: #374151; /* ì§„í•œ íšŒìƒ‰ ê¸€ì”¨ */
        font-size: 14px;
        cursor: pointer;
        transition: all 0.15s ease-in-out;
    }

    .candidate-btn:hover {
        background-color: #eff6ff; /* ì—°í•œ íŒŒë€ ë°°ê²½ */
        border-color: #60a5fa; /* íŒŒë€ í…Œë‘ë¦¬ */
    }
</style>

<h1> ì±—ë´‡ í…ŒìŠ¤íŠ¸ </h1>

<input type="text" id="chatbotText">
<div id="chat-box"></div>
<div id="candidateContainer"></div>
<button onClick="sendMessage();">ë³´ë‚´ê¸°</button>


<img onClick="showChatBot();"
     src="/images/ìƒë‹´ë´‡_ì•„ì´ì½˜.png"
     class="w-[50px] h-[50px] rounded-[202.5px] object-cover border border-black fixed bottom-5 right-5 cursor-pointer"
/>