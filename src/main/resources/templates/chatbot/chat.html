<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="common/head::head"></head> <!-- âœ… ê³µë°± ì œê±° -->

<script>
    function toggleChatBotUI() {
        $(".chatbot").toggleClass('hidden');
    }

    function sendMessage() {
        let message = $("#chatbotText").val();
        const $chatBox = $("#chat-box");
        $.ajax({
            type: "POST",
            url: "sendMessage",
            data: {message: message},
            success: function (data) {

                // ì—¬ëŸ¬ ê°œì˜ ì‹œêµ°êµ¬ê°€ ìˆì„ ì‹œ
                if (data.resultCode === "F-3") {
                    const candidates = data.data1;

                    // ê¸°ì¡´ í‘œì‹œ ì˜ì—­ ë¹„ìš°ê¸°
                    $("#candidateContainer").empty();

                    // ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
                    $("#candidateContainer").append(
                        `<p>${data.msg || "ë™ ì´ë¦„ì´ ì—¬ëŸ¬ êµ¬ì— ìˆì–´ìš”. ì •í™•í•œ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”."}</p>`
                    );

                    // í›„ë³´ ë²„íŠ¼ ìƒì„±
                    candidates.forEach(function (c) {
                        const label = [c.sidoNm, c.sggNm, c.emdNm ?? c.emd].filter(Boolean).join(" ");

                        $("<button>")
                            .text(label)
                            .addClass("candidate-btn")
                            .on("click", function () {
                                // í˜„ì¬ success ìŠ¤ì½”í”„ì˜ messageëŠ” ë°”ê¹¥ ë³€ìˆ˜ë¼ í˜¼ë™ë  ìˆ˜ ìˆìœ¼ë‹ˆ ìƒˆë¡œ êµ¬ì„±
                                const newMessage = $("#chatbotText").val() + " " + c.sggNm;

                                // ì…ë ¥ì°½ ì—…ë°ì´íŠ¸ í›„ ì¬í˜¸ì¶œ
                                $("#chatbotText").val(newMessage);
                                $("#candidateContainer").empty();   // í›„ë³´ UI ì •ë¦¬
                                sendMessage();                      // âœ… ê¸°ì¡´ í•¨ìˆ˜ ì¬ì‚¬ìš©
                            })
                            .appendTo("#candidateContainer");
                    });
                    return;
                }

                // ì—…ì¢… ì„ íƒì„ í•´ì•¼í•  ì‹œ
                if (data.resultCode === "F-4") {
                    const upjongs = data.data1;
                    const message = data.data2;

                    $chatBox.append(`<div class="bot-msg"><b>ì±—ë´‡:</b>ì•„ë˜ì—ì„œ ì—…ì¢…ì„ ì„ íƒí•˜ë©´ ë§¤ì¶œ ë°ì´í„°ë¥¼ ë³´ì—¬ë“œë¦´ê²Œìš”.</div>`);

                    let btnHtml = '<div class="grid grid-cols-2 gap-2 mt-2 max-h-64 overflow-y-auto pr-2">';
                    upjongs.forEach(u => {
                        btnHtml += `<button
                          class="p-2 rounded-lg bg-blue-100 hover:bg-blue-200 candidate-upjong"
                          data-upjong="${u.upjongCd}">
                          ${u.upjongNm}
                        </button>`;
                    });
                    btnHtml += '</div>';

                    $chatBox.append(btnHtml);

                    // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡
                    $(".candidate-upjong").on("click", function () {
                        const selectedCd = $(this).data("upjong");
                        const selectedNm = $(this).text();
                        $("#chatbotText").val(message + " " + selectedNm.trim()); // ì…ë ¥ì°½ ê°±ì‹ 
                        sendMessage(); // ë‹¤ì‹œ ì„œë²„ë¡œ ìš”ì²­
                    });

                    return;
                }

                const flaskResult = data.data1;
                const sido = flaskResult.sido;
                const sigungu = flaskResult.sigungu;
                const emd = flaskResult.emd;

                const regionText = [sido, sigungu, emd]
                    .filter(val => val && val !== "")
                    .join(" ");

                // ë§¤ì¶œì•¡ ëŒ€ë‹µ
                if (data.resultCode === "S-1") {
                    const upjongCode = data.data2;
                    const dataSets = data.data3;


                    // ì°¨íŠ¸ìš© ë°°ì—´
                    const labels = [];       // ë¶„ê¸° (20241, 20242 ...)
                    const salesValues = [];  // ë§¤ì¶œì•¡

                    dataSets.forEach(data => {
                        labels.push(data.baseYearQuarterCode);   // ë˜ëŠ” item.baseYearQuarterCode ê°™ì€ í‚¤
                        salesValues.push(data.monthlySalesAmount); // ë§¤ì¶œì•¡ ì»¬ëŸ¼ëª… ë§ê²Œ ìˆ˜ì •
                    });

                    $chatBox.append(`<div class="bot-msg"><b>ì±—ë´‡:</b> ${upjongCode.upjongNm}ì˜ ë§¤ì¶œì•¡ ë°ì´í„°ì…ë‹ˆë‹¤.</div>`);

                    if (window.salesChart) {
                        window.salesChart.destroy();
                    }
                    // ì°¨íŠ¸ container ì´ˆê¸°í™” í›„ ë‹¤ì‹œ ì¶”ê°€
                    $("#chartContainer").remove();
                    $chatBox.append(`
                      <div id="chartContainer">
                          <canvas id="salesChart"></canvas>
                      </div>
                    `);

                    // Chart.js (Line ì°¨íŠ¸ ì˜ˆì‹œ)
                    const ctx = document.getElementById("salesChart").getContext("2d");

                    new Chart(ctx, {
                        type: "bar", // ë˜ëŠ” "bar"
                        data: {
                            labels: labels,
                            datasets: [{
                                label: "ë¶„ê¸°ë³„ ë§¤ì¶œì•¡",
                                data: salesValues,
                                borderColor: "rgba(54, 162, 235, 1)",
                                backgroundColor: "rgba(54, 162, 235, 0.2)",
                                fill: true,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function (value) {
                                            return (value / 100000000).toLocaleString() + " ì–µ";
                                        }
                                    }
                                }
                            }
                        }
                    });

                }

                // ìœ ë™ì¸êµ¬ ëŒ€ë‹µ
                if (data.resultCode === "S-2") {
                    const dataSet = data.data2;
                    const percentile = data.data3
                    console.log(dataSet)

                    // ì„±ë³„ ê´€ë ¨ ì„¤ì •
                    const genderKor = flaskResult.gender === "male" ? "ë‚¨ì„±" : "ì—¬ì„±";
                    const genderValue = flaskResult.gender === "male" ? dataSet.maleFloatingPopulation : dataSet.femaleFloatingPopulation;

                    // ë‚˜ì´ëŒ€ ê´€ë ¨ ì„¤ì •
                    const convertAgeKey = (ageGroup) => {
                        if (!ageGroup) return null;
                        const baseKey = ageGroup.replace("age_", "age"); // age_20 â†’ age20
                        return baseKey + "FloatingPopulation";           // age20 â†’ age20FloatingPopulation
                    };

                    const ageGroupMap = {
                        "age_10": "10ëŒ€",
                        "age_20": "20ëŒ€",
                        "age_30": "30ëŒ€",
                        "age_40": "40ëŒ€",
                        "age_50": "50ëŒ€",
                        "age_60": "60ëŒ€"
                    };

                    const rawAgeGroup = flaskResult.ageGroup;         // ì˜ˆ: "age_20"
                    const ageKor = ageGroupMap[rawAgeGroup];          // ì˜ˆ: "20ëŒ€"
                    const ageKey = convertAgeKey(rawAgeGroup);        // ì˜ˆ: "age20"
                    const ageValue = dataSet?.[ageKey];     // ì˜¬ë°”ë¥´ê²Œ ì ‘ê·¼


                    if (flaskResult.gender === "" && flaskResult.ageGroup === "") {
                        // ì„±ë³„ë„ ì—†ê³ , ë‚˜ì´ëŒ€ë„ ì—†ì„ ë•Œ â†’ ì „ì²´ ì¸êµ¬ ì¶œë ¥
                        $chatBox.append(`<div class="bot-msg"><b>ì±—ë´‡:</b> ${regionText}ì˜ ì „ì²´ ìœ ë™ì¸êµ¬ëŠ” ${dataSet.totalFloatingPopulation}ëª…ì…ë‹ˆë‹¤.</div>`);
                        $chatBox.append(`
                          <div class="bot-msg">
                            <b>ì±—ë´‡:</b> ${regionText}ì€(ëŠ”) ì„œìš¸ ì „ì²´ ì§€ì—­ ì¤‘ <b>ìƒìœ„ ${percentile}%</b>ì— í•´ë‹¹í•©ë‹ˆë‹¤ ğŸš€
                          </div>
                        `);

                    } else if (flaskResult.gender !== "" && flaskResult.ageGroup === "") {
                        // ì„±ë³„ë§Œ ìˆì„ ë•Œ
                        $chatBox.append(`<div class="bot-msg"><b>ì±—ë´‡:</b> ${regionText}ì˜ ${genderKor} ìœ ë™ì¸êµ¬ëŠ” ${genderValue}ëª…ì…ë‹ˆë‹¤.</div>`);
                        $chatBox.append(`
                          <div class="bot-msg">
                            <b>ì±—ë´‡:</b> ${regionText}ì˜ ${genderKor} ìœ ë™ì¸êµ¬ëŠ” ì„œìš¸ ì „ì²´ ì§€ì—­ ì¤‘ <b>ìƒìœ„ ${percentile}%</b>ì— í•´ë‹¹í•©ë‹ˆë‹¤ ğŸš€
                          </div>
                        `);
                    } else if (flaskResult.gender === "" && flaskResult.ageGroup !== "") {
                        // ë‚˜ì´ëŒ€ë§Œ ìˆì„ ë•Œ

                        $chatBox.append(`<div class="bot-msg"><b>ì±—ë´‡:</b> ${regionText}ì˜ ${ageKor} ìœ ë™ì¸êµ¬ëŠ” ${ageValue}ëª…ì…ë‹ˆë‹¤.</div>`);
                        $chatBox.append(`
                          <div class="bot-msg">
                            <b>ì±—ë´‡:</b> ${regionText}ì˜ ${ageKor} ìœ ë™ì¸êµ¬ëŠ” ì„œìš¸ ì „ì²´ ì§€ì—­ ì¤‘ <b>ìƒìœ„ ${percentile}%</b>ì— í•´ë‹¹í•©ë‹ˆë‹¤ ğŸš€
                          </div>
                        `);
                    } else {
                        // ì„±ë³„ + ë‚˜ì´ëŒ€ ëª¨ë‘ ìˆì„ ë•Œ â†’ ì¡°í•© ë°ì´í„°ëŠ” ì—†ìœ¼ë¯€ë¡œ ë”°ë¡œ ì•ˆë‚´

                        $chatBox.append(`<div class="bot-msg"><b>ì±—ë´‡:</b>"${regionText}ì˜ ${ageKor} ${genderKor}"ì— ëŒ€í•œ ì •í™•í•œ ì¸êµ¬ìˆ˜ëŠ” ì œê³µë˜ì§€ ì•Šì§€ë§Œ,<br>
                    ê°ê°ì˜ í†µê³„ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤ ğŸ˜Š <br>
                    ğŸ‘‰ ${ageKor} ì¸êµ¬: ${ageValue}ëª…<br>
                    ğŸ‘‰ ${genderKor} ì¸êµ¬: ${genderValue}ëª…</div>`);
                    }

                    // ===== Chart.js ì¶”ê°€ ë¶€ë¶„ =====
                    // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
                    if (window.populationChart) {
                        window.populationChart.destroy();
                    }
                    if (window.genderChart) {
                        window.genderChart.destroy();
                    }

                    // ì°¨íŠ¸ ë‚˜ì˜¬ container ì„¤ì •

                    $("#chartContainer").remove();
                    $chatBox.append(`
                          <div id="chartContainer">
                              <canvas id="genderChart"></canvas>
                              <canvas id="populationChart"></canvas>
                          </div>
                        `);

                    // ===== 1. ì„±ë³„ ì›í˜• ì°¨íŠ¸ =====
                    const genderCtx = document.getElementById("genderChart").getContext("2d");
                    window.genderChart = new Chart(genderCtx, {
                        type: "doughnut",   // pie ë¡œë„ ê°€ëŠ¥
                        data: {
                            labels: ["ë‚¨ì„±", "ì—¬ì„±"],
                            datasets: [{
                                label: regionText + " ì„±ë³„ ìœ ë™ì¸êµ¬",
                                data: [
                                    dataSet.maleFloatingPopulation,
                                    dataSet.femaleFloatingPopulation
                                ],
                                backgroundColor: ["#36A2EB", "#FF6384"]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {display: true, text: regionText + " ì„±ë³„ ìœ ë™ì¸êµ¬"}
                            }
                        }
                    });

                    // ===== 2. ì—°ë ¹ëŒ€ ë§‰ëŒ€ ì°¨íŠ¸ =====
                    const ageCtx = document.getElementById("populationChart").getContext("2d");
                    window.populationChart = new Chart(ageCtx, {
                        type: "bar",
                        data: {
                            labels: ["10ëŒ€", "20ëŒ€", "30ëŒ€", "40ëŒ€", "50ëŒ€", "60ëŒ€"],
                            datasets: [{
                                label: regionText + " ì—°ë ¹ëŒ€ë³„ ìœ ë™ì¸êµ¬",
                                data: [
                                    dataSet.age10FloatingPopulation,
                                    dataSet.age20FloatingPopulation,
                                    dataSet.age30FloatingPopulation,
                                    dataSet.age40FloatingPopulation,
                                    dataSet.age50FloatingPopulation,
                                    dataSet.age60PlusFloatingPopulation
                                ],
                                backgroundColor: "#4CAF50"
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {display: false},
                                title: {display: true, text: regionText + " ì—°ë ¹ëŒ€ë³„ ìœ ë™ì¸êµ¬"}
                            }
                        }
                    });

                }


                // ì²­ì•½ ë°ì´í„° ì¶œë ¥ ë¡œì§
                if (data.resultCode === "S-4") {
                    const lhSupplyInfos = data.data2;

                    console.log(lhSupplyInfos);

                    let tableHtml = `
                        <div class="bot-msg">
                            <b>ì±—ë´‡:</b> í˜„ì¬ ëª¨ì§‘ ì¤‘ì¸ ì²­ì•½ ë°ì´í„° ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.<br><br>
                            <div class="overflow-x-auto">
                                <table class="table table-zebra table-bordered w-full border border-gray-300">
                                    <thead>
                                        <tr>
                                            <th>ê³µê³  ì´ë¦„</th>
                                            <th>ì§€ì—­</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    lhSupplyInfos.forEach(lh => {
                        tableHtml += `
                            <tr>
                                <td class="border border-gray-300">
                                    <a href="/lh/${lh.id}" target="_blank" class="text-blue-600 hover:underline">
                                        ${lh.title}
                                    </a>
                                </td>
                                <td class="border border-gray-300">${lh.address.replace(/(íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ|íŠ¹ë³„ìì¹˜ì‹œ|íŠ¹ë³„ìì¹˜ë„|ë„)/g, "") || "ì •ë³´ ì—†ìŒ"}</td>
                            </tr>
                        `;
                    });

                    tableHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;

                    $chatBox.append(tableHtml);
                }


                $("#chatbotText").val("");  // ì…ë ¥ì°½ ë¹„ìš°ê¸°
                $chatBox.scrollTop($chatBox[0].scrollHeight); // ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ
            }
            ,
            error: function () {
                $chatBox.append(`<div class="bot-msg"><b>ì±—ë´‡:</b> ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`);
            }
        });
    }
</script>
<style>
    .candidate-btn {
        display: block;
        width: 500px;
        padding: 10px 14px;
        margin-bottom: 8px;
        text-align: left;
        border: 1px solid #d1d5db; /* íšŒìƒ‰ í…Œë‘ë¦¬ */
        border-radius: 8px;
        background-color: white;
        color: #374151; /* ì§„í•œ íšŒìƒ‰ ê¸€ì”¨ */
        font-size: 14px;
        cursor: pointer;
        transition: all 0.15s ease-in-out;
    }

    .candidate-btn:hover {
        background-color: #eff6ff; /* ì—°í•œ íŒŒë€ ë°°ê²½ */
        border-color: #60a5fa; /* íŒŒë€ í…Œë‘ë¦¬ */
    }
</style>


<div
        class="chatbot fixed bottom-20 right-5 flex flex-col justify-between items-center w-[350px] h-[600px] overflow-hidden rounded-[10px] bg-[#7aaec1] border border-black"
>
    <div
            class="flex justify-center items-center flex-grow-0 flex-shrink-0 w-[350px] relative overflow-hidden border-t-0 border-r-0 border-b border-l-0 border-black"
    >
        <img
                src="/images/ìƒë‹´ë´‡_ë¯¸ë‹ˆver.png"
                class="flex-grow-0 flex-shrink-0 w-[50px] h-[50px] rounded-tl-[75px] object-cover"
        />
        <p class="flex-grow-0 flex-shrink-0 w-[250px] text-xl text-center text-black">í„°ë§ˆë£¨ ìƒë‹´ë´‡</p>

        <i class="fa-solid fa-xmark fa-2x flex-grow-0 flex-shrink-0 rounded-tr-[25px] object-cover"></i>
    </div>
    <div id="chat-box"
         class="flex flex-col justify-start items-start self-stretch flex-grow w-[350px] h-[450px] overflow-auto gap-2.5 p-2.5"
    ></div>
    <div
            class="flex justify-center items-center flex-grow-0 flex-shrink-0 w-[350px] relative overflow-hidden border-t border-black "
    >
        <form id="chatForm" onsubmit="sendMessage(); return false;" class="flex w-full">
            <input
                    type="text"
                    id="chatbotText"
                    class="flex justify-center items-center flex-grow relative overflow-hidden gap-2.5 py-[25px] bg-white pl-1 border-none focus:outline-none"
                    placeholder="ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”"
                    autocomplete="off"
            >
            <button type="submit" class="cursor-pointer w-[50px] flex justify-center items-center">
                <i class="fa-solid fa-arrow-right fa-2x flex-grow-0 flex-shrink-0 rounded-[512px] object-cover"></i>
            </button>
        </form>
    </div>
</div>

<img onClick="toggleChatBotUI();"
     src="/images/ìƒë‹´ë´‡_ì•„ì´ì½˜.png"
     class="w-[50px] h-[50px] rounded-[202.5px] object-cover border border-black fixed bottom-5 right-5 cursor-pointer"
/>