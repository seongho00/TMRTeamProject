<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="common/head::head"></head>
<footer th:replace="common/header::header"></footer>

<!-- 카카오맵 -->
<script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=819000337dba5ebac1dbf7847f383c66&libraries=services&autoload=false"></script>

<!-- 카카오맵 관련 코드 -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        kakao.maps.load(function () {
            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(36.3504, 127.3845), // 대전 중심
                level: 6
            };
            const map = new kakao.maps.Map(mapContainer, mapOption);

            // ✅ GeoJSON 파일 불러오기
            fetch("/daejeon_emds.geojson") // ← 실제 파일 경로로 수정
                .then(res => res.json())
                .then(geojson => {
                    geojson.features.forEach(feature => {
                        const geometry = feature.geometry;
                        const properties = feature.properties;

                        if (geometry.type === "Polygon") {
                            drawPolygon([geometry.coordinates], properties);
                        } else if (geometry.type === "MultiPolygon") {
                            geometry.coordinates.forEach(polygon => {
                                drawPolygon([polygon], properties);
                            });
                        }
                    });
                });

            // ✅ 다각형 그리는 함수
            function drawPolygon(coordinatesArray, properties) {
                const paths = coordinatesArray[0][0].map(coord =>
                    new kakao.maps.LatLng(coord[1], coord[0])
                );

                const polygon = new kakao.maps.Polygon({
                    map: map,
                    path: paths,
                    strokeWeight: 2,
                    strokeColor: '#004c80',
                    strokeOpacity: 0.8,
                    fillColor: '#00a0e9',
                    fillOpacity: 0.3
                });

                // ✅ 마우스 오버 시 행정동 이름 표시
                const infowindow = new kakao.maps.InfoWindow({removable: true});
                kakao.maps.event.addListener(polygon, 'mouseover', function (mouseEvent) {
                    infowindow.setContent(`<div style="padding:5px;font-size:14px;">${properties.ADM_NM}</div>`);
                    infowindow.setPosition(mouseEvent.latLng);
                    infowindow.open(map);
                });

                kakao.maps.event.addListener(polygon, 'mouseout', function () {
                    infowindow.close();
                });
            }
        });
    });
</script>

<script>
    $(document).ready(function () {
        // 지역 선택 UI 시군구 선택 시 그에 해당되는 행정동 나오게끔
        $('#sggSelect').on('change', function () {
            const sgg = $(this).val();

            // 행정동 초기화
            $('#emdSelect').empty().append('<option value="">행정동</option>');

            if (sgg) {
                $.ajax({
                    url: 'getEmds',
                    method: 'GET',
                    data: {sgg: sgg},
                    success: function (adminDongs) {

                        $.each(adminDongs, function (index, adminDong) {
                            $('#emdSelect').append(
                                $('<option>', {value: adminDong.emdNm, text: adminDong.emdNm})
                            );
                        });
                    },
                    error: function () {
                        alert('행정동 정보를 가져오는데 실패했습니다.');
                    }
                });
            }
        });

        // 대분류 클릭 시 그에 해당하는 중분류 나오는 코드
        $(".major-item").click(function () {
            const majorCd = $(this).data("majorcd");

            $.ajax({
                url: "getMiddleCategories",   // 🔁 실제 서버 엔드포인트로 수정
                method: "GET",                  // 또는 "POST"
                data: {majorCd: majorCd},
                success: function (upjongCodes) {
                    // li 항목만 생성
                    let liHTML = "";

                    upjongCodes.forEach(item => {
                        liHTML += `
                          <li class="middle-item h-12 w-full text-xl font-medium text-center text-black cursor-pointer hover:bg-gray-100"
                              data-middleCd="${item.middleCd}">
                            ${item.middleNm}
                          </li>
                        `;
                    });

                    // 기존 ul 안에 li 추가 (ul은 유지)
                    $(".middleSelector ul").html(liHTML);
                    $(".middleSelector").removeClass('hidden');
                },
                error: function () {
                    alert("중분류 데이터를 불러오는 데 실패했습니다.");
                }
            });

        });


        // 중분류 클릭 시 그에 해당하는 소분류 나오는 코드
        $(document).on("click", ".middle-item", function () {
            const middleCd = $(this).data("middlecd");

            $.ajax({
                url: "getMinorCategories",   // 🔁 실제 서버 엔드포인트로 수정
                method: "GET",                  // 또는 "POST"
                data: {middleCd: middleCd},
                success: function (upjongCodes) {
                    // li 항목만 생성
                    let liHTML = "";

                    upjongCodes.forEach(item => {
                        liHTML += `
                          <li class="minor-item h-12 w-full text-xl font-medium text-center text-black cursor-pointer hover:bg-gray-100"
                              data-minorCd="${item.minorCd}">
                            ${item.minorNm}
                          </li>
                        `;
                    });

                    // 기존 ul 안에 li 추가 (ul은 유지)
                    $(".minorSelector ul").html(liHTML);
                    $(".minorSelector").removeClass('hidden');
                },
                error: function () {
                    alert("소분류 데이터를 불러오는 데 실패했습니다.");
                }
            });
        });

        // 소분류 클릭 시
        $(document).on("click", ".minor-item", function () {
            const minorCd = $(this).data("minorcd");

            $.ajax({
                url: "getUpjongCodeByMinorCd",   // 🔁 실제 서버 엔드포인트로 수정
                method: "GET",                  // 또는 "POST"
                data: {minorCd: minorCd},
                success: function (upjongCode) {

                    $('.upjongInput').val(upjongCode.majorNm + " > " + upjongCode.middleNm + " > " + upjongCode.minorNm);

                    $('.middleSelector').addClass('hidden');
                    $('.minorSelector').addClass('hidden');
                },
                error: function () {
                    alert("데이터를 불러오는 데 실패했습니다.");
                }
            });
        });

    });

</script>

<style>
    .majorSelector li {
        cursor: pointer;
    }

    .middelSelector li {
        cursor: pointer;
    }

</style>

<!-- 카카오맵 -->
<div id="map" style="width: 100%; height: 600px;"></div>

<!-- 지역 선택 UI -->
<ul class="flex justify-between items-center w-[450px] h-[47px] overflow-hidden  px-[10px] py-[15px] rounded-[10px] bg-white border border-black absolute left-1/2 -translate-x-1/2 top-[100px]">
    <li class="flex justify-center items-center h-[41px] cursor-pointer">

        <select class="flex justify-center items-center text-[22px] text-center text-black cursor-pointer focus:outline-none focus:ring-0 focus:border-transparent"
                name="sidoSelect"
                id="sidoSelect">
            <option>대전광역시</option>
        </select>

    </li>
    <li class="flex justify-center items-center h-[41px]  ">
        <select class="flex justify-center items-center text-[22px] text-center text-black cursor-pointer focus:outline-none focus:ring-0 focus:border-transparent"
                name="sggSelect"
                id="sggSelect">
            <option value="">시/군/구</option>
            <option value="동구">동구</option>
            <option value="중구">중구</option>
            <option value="서구">서구</option>
            <option value="유성구">유성구</option>
            <option value="대덕구">대덕구</option>
        </select>
    </li>
    <li class="flex justify-center items-center h-[41px] ">
        <select class="flex justify-center items-center text-[22px] text-center text-black cursor-pointer focus:outline-none focus:ring-0 focus:border-transparent"
                name="emdSelect"
                id="emdSelect">
            <option>행정동</option>
        </select>
    </li>
</ul>

<!-- 업종 선택 UI -->
<div class="flex absolute top-[180px] left-[150px] justify-start items-start overflow-hidden gap-2.5 px-[7px] py-1">
    <div
            class="flex flex-col justify-start items-center flex-grow-0 flex-shrink-0 h-[615px] w-[445px] overflow-hidden gap-[31px] pt-[30px] pb-[99px] rounded-[15px] bg-white border border-black"
    >
        <div
                class="flex justify-start items-center self-stretch flex-grow-0 flex-shrink-0 h-[46px] relative overflow-hidden gap-2.5 pl-[30px] pr-[83px]"
        >
            <p
                    class="flex-grow-0 flex-shrink-0 w-[165px] h-[46px] text-xl font-medium text-left text-black"
            >
                점수 확인
            </p>
        </div>
        <div
                class="flex flex-col justify-start items-start flex-grow-0 flex-shrink-0 overflow-hidden gap-5"
        >
            <div
                    class="flex flex-col justify-center items-center flex-grow-0 flex-shrink-0 w-[407px] overflow-hidden gap-2.5 px-[104px] py-2.5"
            >
                <div
                        class="flex justify-between items-center flex-grow-0 flex-shrink-0 w-[381px] h-[41px] relative gap-2.5 px-2.5 py-[7px] rounded-[15px] bg-white border border-black"
                >
                    <input placeholder="업종을 입력해주세요"
                           class="upjongInput flex-grow flex-shrink-0  text-xl font-medium text-left focus:outline-none focus:border-none"
                    />
                    <svg
                            width="22"
                            height="22"
                            viewBox="0 0 22 22"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg"
                            class="flex-grow-0 flex-shrink-0 w-[21px] h-[21.5px]"
                            preserveAspectRatio="none"
                    >
                        <circle cx="9" cy="9" r="8.5" transform="matrix(-1 0 0 1 18 0)" stroke="black"></circle>
                        <path d="M15 15.5L21 21.5" stroke="black" stroke-linecap="round"></path>
                    </svg>
                </div>
            </div>
            <div
                    class="majorSelector flex flex-col justify-center items-center flex-grow-0 flex-shrink-0 w-[407px] overflow-hidden gap-[19px]"
            >
                <ul class="flex justify-between items-center self-stretch flex-grow-0 flex-shrink-0 h-[35px] relative overflow-hidden px-[5px]">
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[79.4px] h-[35px] text-[15px] text-center text-black border border-black cursor-pointer"
                        data-majorCd="L1">
                        부동산
                    </li>
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[79.4px] h-[35px] text-[15px] text-center text-black cursor-pointer"
                        data-majorCd="I1">
                        숙박
                    </li>
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[79.4px] h-[35px] text-[15px] text-center text-black cursor-pointer"
                        data-majorCd="M1">
                        과학/기술
                    </li>
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[79.4px] h-[35px] text-[15px] text-center text-black cursor-pointer"
                        +
                        data-majorCd="Q1">
                        보건/의료
                    </li>
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[79.4px] h-[35px] text-[15px] text-center text-black cursor-pointer"
                        data-majorCd="N1">
                        관리/임대
                    </li>
                </ul>

                <ul class="flex justify-between items-center self-stretch flex-grow-0 flex-shrink-0 h-[35px] relative overflow-hidden">
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[81.4px] h-[35px] text-[15px] text-center text-black cursor-pointer"
                        data-majorCd="G2">
                        소매
                    </li>
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[81.4px] h-[35px] text-[15px] text-center text-black cursor-pointer"
                        data-majorCd="I2">
                        음식
                    </li>
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[81.4px] h-[35px] text-[15px] text-center text-black cursor-pointer"
                        data-majorCd="S2">
                        수리
                    </li>
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[81.4px] h-[35px] text-[15px] text-center text-black cursor-pointer"
                        data-majorCd="R1">
                        예체능
                    </li>
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[81.4px] h-[35px] text-[15px] text-center text-black cursor-pointer"
                        data-majorCd="P1">
                        교육
                    </li>
                </ul>

            </div>
        </div>
        <div
                class="flex justify-center items-center flex-grow-0 flex-shrink-0 relative overflow-hidden gap-2.5 px-[115px] py-2.5 rounded-[10px] bg-[#10f] cursor-pointer"
        >
            <p class="flex justify-center items-center flex-grow-0 flex-shrink-0 w-36 h-[38px] text-xl font-medium text-center text-white ">
                확인
            </p>
        </div>
        <div
                class="flex flex-col justify-center items-center flex-grow-0 flex-shrink-0 h-[181px] relative overflow-hidden gap-[35px] px-[53px]"
        >
            <p
                    class="flex-grow-0 flex-shrink-0 w-[150px] h-[88px] text-xl font-medium text-center text-black"
            >
        <span
                class="flex-grow-0 flex-shrink-0 w-[150px] h-[88px] text-xl font-medium text-center text-black"
        >확인 입력 시 </span
        ><br/><span
                    class="flex-grow-0 flex-shrink-0 w-[150px] h-[88px] text-xl font-medium text-center text-black"
            >점수 뜨는 곳</span
            >
            </p>
            <div
                    class="flex justify-center items-center flex-grow-0 flex-shrink-0 w-[205px] h-12 relative overflow-hidden gap-2.5 px-[58px] rounded-[5px] bg-[#10f]"
            >
                <p
                        class="flex-grow-0 flex-shrink-0 w-[102px] h-8 text-xl font-medium text-center text-white cursor-pointer"
                >
                    상세보기
                </p>
            </div>
        </div>
    </div>
    <div
            class="middleSelector hidden flex justify-center items-center flex-grow-0 flex-shrink-0 w-[386px] h-[200px] gap-2.5 px-[10px] rounded-[15px] bg-white border border-black"
    >
        <ul
                class="flex flex-col justify-start items-center w-full self-stretch flex-grow-0 flex-shrink-0 relative overflow-auto gap-2.5 p-2.5"
        >

        </ul>
    </div>
    <div
            class="minorSelector hidden flex justify-center items-center flex-grow-0 flex-shrink-0 w-[386px] h-[200px] gap-2.5 px-[23px] py-[13px] rounded-[15px] bg-white border border-black"
    >
        <ul
                class="flex flex-col justify-start w-full items-center self-stretch flex-grow-0 flex-shrink-0 relative overflow-auto gap-2.5 p-2.5"
        >
        </ul>
    </div>
</div>
