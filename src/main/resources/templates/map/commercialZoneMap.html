<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="common/head::head">
    <meta charset="UTF-8">
    <title>지도기반 유동인구와 매출액 분석</title>
</head>
<body>
<header th:replace="common/mapHeader::header"></header>

<!-- 카카오맵 SDK: autoload=false 이므로 kakao.maps.load(...) 필수 -->
<script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=69544617df3febfc879cd18eed451ba3&libraries=services&autoload=false"></script>


<!-- 지도 영역 -->
<div id="map" class="w-full h-[1080px]"></div>

<!-- 상단 탭바: 매출/유동인구 전환 -->
<div id="topMetricTabs"
     class="fixed left-1/2 -translate-x-1/2 top-[90px] z-30 mt-6
            flex items-center gap-2 rounded-full bg-white/90 backdrop-blur
            border border-gray-200 shadow px-2 py-1">
    <!-- 탭 버튼 -->
    <button id="tab-sales"
            class="metric-tab active px-5 py-2 rounded-full text-sm font-semibold">
        매출
    </button>
    <button id="tab-floating"
            class="metric-tab px-5 py-2 rounded-full text-sm font-semibold">
        유동인구
    </button>
</div>

<!-- 좌측 패널 -->
<aside class="absolute top-[160px] left-[40px] z-20 w-[420px] bg-white/90 backdrop-blur rounded-2xl border border-gray-200 shadow-2xl overflow-hidden">

    <!-- 패널 헤더 : 제목 + 메트릭 탭 -->
    <header class="sticky top-0 bg-gradient-to-r from-indigo-600 to-indigo-500 text-white px-6 py-5">
        <!-- 제목 -->
        <h2 class="text-xl font-extrabold tracking-tight">행정동 분석 정보</h2>
        <!-- 부제(선택된 행정동 라벨) -->
        <p id="emdName" class="mt-1 text-sm/6 text-indigo-100">행정동을 선택해 주세요</p>
    </header>

    <!-- 본문 컨테이너 -->
    <div class="p-6 space-y-6">

        <!-- 영역 선택 섹션 : 셀렉트 3종 -->
        <section class="rounded-xl border border-gray-100 bg-white shadow-sm p-4">
            <!-- 섹션 제목 -->
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-gray-800">지역 선택</h3>
                <!-- 기준일 표시 영역(옵션) -->
                <span id="panel-updated-at" class="text-xs text-gray-500"></span>
            </div>

            <!-- 3분할 그리드 -->
            <div class="grid grid-cols-1 gap-2">
                <!-- 시/도 -->
                <label class="flex items-center gap-2">
                    <span class="w-16 shrink-0 text-xs text-gray-500">시/도</span>
                    <select id="sidoSelect"
                            class="w-full rounded-lg border-gray-300 text-sm px-3 py-2
                         focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option>서울특별시</option>
                    </select>
                </label>

                <!-- 시/군/구 -->
                <label class="flex items-center gap-2">
                    <span class="w-16 shrink-0 text-xs text-gray-500">시/군/구</span>
                    <select id="sggSelect"
                            class="w-full rounded-lg border-gray-300 text-sm px-3 py-2
                         focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">선택</option>
                        <!-- 서버 렌더링 영역 -->
                        <th:block th:each="adminDong : ${adminDongsGroupBySggCd}">
                            <option th:value="${adminDong.sggNm}" th:text="${adminDong.sggNm}"></option>
                        </th:block>
                    </select>
                </label>

                <!-- 행정동 -->
                <label class="flex items-center gap-2">
                    <span class="w-16 shrink-0 text-xs text-gray-500">행정동</span>
                    <select id="emdSelect"
                            class="w-full rounded-lg border-gray-300 text-sm px-3 py-2
                         focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">선택</option>
                    </select>
                </label>
            </div>
        </section>

        <!-- 메트릭 카드 : 유동인구 -->
        <section id="card-floating"
                 class="rounded-xl border border-gray-100 bg-gradient-to-b from-white to-indigo-50/60
                    shadow-sm p-4">
            <!-- 카드 헤더 -->
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold text-gray-800">유동인구</h3>
                <!-- 그래프 보기(옵션) -->
                <button id="show-fp-graph"
                        class="px-2 py-0.5 rounded-full text-[11px] font-medium bg-indigo-100 text-indigo-700 cursor-pointer"
                        onclick="openReport();">
                    그래프 보기
                </button>
            </div>

            <!-- 핵심 숫자 -->
            <p id="floatingPopulation"
               class="mt-2 text-3xl font-extrabold tracking-tight text-gray-900">-</p>

            <!-- 보조 라벨 -->
            <p class="mt-1 text-xs text-gray-500">단위: 만명</p>

            <!-- 미세 지표 2열 (옵션) -->
            <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
                <div class="rounded-lg bg-white border border-gray-100 p-3">
                    <p class="text-gray-500 text-xs">당월 매출 추정</p>
                    <p id="sales-per-capita-fp" class="font-semibold text-gray-800">-</p>
                    <!-- 보조 라벨 -->
                    <p class="mt-1 text-[8px] text-gray-500">단위: 억원</p>
                </div>
                <div class="rounded-lg bg-white border border-gray-100 p-3">
                    <p class="text-gray-500 text-xs">최근 분기</p>
                    <p id="recent-period-fp" class="font-semibold text-gray-800">-</p>
                </div>
            </div>
        </section>

        <!-- 도움말 -->
        <p class="text-[12px] text-gray-500">
            지도에서 행정동을 클릭하거나 상단의 지역 선택을 변경하면 카드가 갱신됩니다.
        </p>
    </div>


</aside>

<!-- 팝업창 -->
<div class="report fixed top-[160px] left-[460px] w-[420px] h-[800px] z-10
            bg-white/90 backdrop-blur rounded-2xl border border-gray-200 shadow-2xl
            transform transition-all duration-300 ease-in-out opacity-0 -translate-x-4">
    <h2>
        분석 리포트
    </h2>

    <!-- 매출액 데이터 -->
    <div class="flex justify-between">
        <span class="font-bold text-xl"><i class="fa-solid fa-won-sign "></i> 매출 분석</span>
        <span class="text-sm text-gray-600"> 25년 1분기 기준</span>
    </div>

    <canvas id="timeSalesChart" width="600" height="300"></canvas>
    <canvas id="weeklyPopulationChart" width="600" height="300"></canvas>
    <canvas id="populationByAgeChart" width="600" height="400"></canvas>

    <!-- 닫기 버튼 -->
    <button
            class="p-0 flex items-center justify-center absolute
         top-3 right-[-1.375rem] z-[225]
         w-[2.75rem] h-[2.75rem]
         rounded-full border border-gray-300
         bg-white shadow-[2px_2px_8px_0_rgba(0,0,0,0.1)] cursor-pointer"
            onclick="closeReport();">
        <i class="fa-solid fa-xmark"></i>
    </button>

</div>


<!-- 지도/업종 스크립트 -->
<script type="text/javascript" th:src="@{/js/commercialZoneMap.js}"></script>

<div th:replace="chatbot/chat::chat"></div>

<footer th:replace="common/footer :: footer"></footer>
</body>
</html>
