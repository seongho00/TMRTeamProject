<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="common/head::head"></head>
<footer th:replace="common/header::header"></footer>

<!-- ì¹´ì¹´ì˜¤ë§µ -->
<script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=819000337dba5ebac1dbf7847f383c66&libraries=services&autoload=false"></script>

<script>
    let currentPolygon = null;
    let currentOverlay = null;

    document.addEventListener("DOMContentLoaded", function () {
        kakao.maps.load(function () {
            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(37.5665, 126.9780),
                level: 6
            };
            const map = new kakao.maps.Map(mapContainer, mapOption);

            const guidePolygons = []; // ì ì„  ê°€ì´ë“œìš© polygon
            const polygons = [];

            // âœ… GeoJSON ë¶ˆëŸ¬ì˜¤ê¸°
            fetch("/seoul_emds.geojson")
                .then(res => res.json())
                .then(geojson => {
                    geojson.features.forEach(feature => {
                        const geometry = feature.geometry;
                        const properties = feature.properties;

                        const multiCoords = (geometry.type === "Polygon")
                            ? [geometry.coordinates]
                            : geometry.coordinates;

                        multiCoords.forEach(polygonCoords => {
                            const coords = polygonCoords[0];
                            const path = coords.map(c => new kakao.maps.LatLng(c[1], c[0]));
                            polygons.push({ path, properties });


                            // ì ì„  ê°€ì´ë“œìš©
                            const guide = new kakao.maps.Polygon({
                                map: map,
                                path: path,
                                strokeWeight: 2,
                                strokeColor: '#999',
                                strokeOpacity: 0.6,
                                strokeStyle: 'dash',   // ì ì„  ìŠ¤íƒ€ì¼
                                fillOpacity: 0          // ì•ˆì€ ë¹„ì›Œë‘ 
                            });
                            guidePolygons.push(guide);
                        });
                    });
                });


            // âœ… Ray-casting ì•Œê³ ë¦¬ì¦˜
            function isPointInPolygon(latLng, path) {
                let x = latLng.getLng(), y = latLng.getLat();
                let inside = false;

                for (let i = 0, j = path.length - 1; i < path.length; j = i++) {
                    let xi = path[i].getLng(), yi = path[i].getLat();
                    let xj = path[j].getLng(), yj = path[j].getLat();

                    let intersect = ((yi > y) !== (yj > y)) &&
                        (x < (xj - xi) * (y - yi) / ((yj - yi) || 1e-10) + xi);

                    if (intersect) inside = !inside;
                }

                return inside;
            }

            // âœ… BoundingBox ë¹ ë¥¸ ì‚¬ì „ í•„í„°
            function getBoundsOfPath(path) {
                let minLat = path[0].getLat(), maxLat = path[0].getLat();
                let minLng = path[0].getLng(), maxLng = path[0].getLng();
                for (let i = 1; i < path.length; i++) {
                    const lat = path[i].getLat(), lng = path[i].getLng();
                    minLat = Math.min(minLat, lat);
                    maxLat = Math.max(maxLat, lat);
                    minLng = Math.min(minLng, lng);
                    maxLng = Math.max(maxLng, lng);
                }
                return {
                    contains(latLng) {
                        return (
                            latLng.getLat() >= minLat &&
                            latLng.getLat() <= maxLat &&
                            latLng.getLng() >= minLng &&
                            latLng.getLng() <= maxLng
                        );
                    }
                };
            }

            // âœ… í´ë¦­ ì´ë²¤íŠ¸
            kakao.maps.event.addListener(map, 'click', function (mouseEvent) {
                const clickedLatLng = mouseEvent.latLng;

                for (let i = 0; i < polygons.length; i++) {
                    const { path, properties } = polygons[i];
                    const bounds = getBoundsOfPath(path);

                    if (!bounds.contains(clickedLatLng)) continue;
                    if (!isPointInPolygon(clickedLatLng, path)) continue;

                    // âœ… ì´ë¯¸ í‘œì‹œëœ ë™ì¼í•œ polygonì„ í´ë¦­í–ˆë‹¤ë©´ â†’ ì œê±°
                    if (currentPolygon && isSamePath(currentPolygon.getPath(), path)) {
                        currentPolygon.setMap(null);
                        currentOverlay.setMap(null);
                        currentPolygon = null;
                        currentOverlay = null;
                        return;
                    }

                    // âœ… ì´ì „ polygon/overlay ì œê±°
                    if (currentPolygon) currentPolygon.setMap(null);
                    if (currentOverlay) currentOverlay.setMap(null);

                    // âœ… í´ë¦¬ê³¤ ê·¸ë¦¬ê¸°
                    const polygon = new kakao.maps.Polygon({
                        map: map,
                        path: path,
                        strokeWeight: 2,
                        strokeColor: '#004c80',
                        strokeOpacity: 0.8,
                        fillColor: '#00a0e9',
                        fillOpacity: 0.3
                    });

                    // âœ… ì¤‘ì‹¬ ì¢Œí‘œ ê³„ì‚°
                    const latSum = path.reduce((sum, p) => sum + p.getLat(), 0);
                    const lngSum = path.reduce((sum, p) => sum + p.getLng(), 0);
                    const center = new kakao.maps.LatLng(latSum / path.length, lngSum / path.length);

                    const overlayContent = document.createElement('div');
                    overlayContent.innerText = properties.ADSTRD_NM;
                    overlayContent.style.cssText = `
                    background: white;
                    border: 1px solid #444;
                    padding: 3px 6px;
                    font-size: 13px;
                    z-index: 1000;
                    position: relative;
                `;

                    const overlay = new kakao.maps.CustomOverlay({
                        content: overlayContent,
                        position: center,
                        yAnchor: 1,
                        zIndex: 3,
                        map: map
                    });

                    currentPolygon = polygon;
                    currentOverlay = overlay;

                    break;  // ì²« ë²ˆì§¸ë¡œ í¬í•¨ëœ polygonë§Œ ì²˜ë¦¬
                }
            });
        });
    });

    function isSamePath(path1, path2) {
        if (!path1 || !path2) return false;
        if (path1.length !== path2.length) return false;
        for (let i = 0; i < path1.length; i++) {
            if (
                path1[i].getLat().toFixed(6) !== path2[i].getLat().toFixed(6) ||
                path1[i].getLng().toFixed(6) !== path2[i].getLng().toFixed(6)
            ) {
                return false;
            }
        }
        return true;
    }
</script>


<script>
    $(document).ready(function () {
        // ì§€ì—­ ì„ íƒ UI ì‹œêµ°êµ¬ ì„ íƒ ì‹œ ê·¸ì— í•´ë‹¹ë˜ëŠ” í–‰ì •ë™ ë‚˜ì˜¤ê²Œë”
        $('#sggSelect').on('change', function () {
            const sgg = $(this).val();

            // í–‰ì •ë™ ì´ˆê¸°í™”
            $('#emdSelect').empty().append('<option value="">í–‰ì •ë™</option>');

            if (sgg) {
                $.ajax({
                    url: 'getEmds',
                    method: 'GET',
                    data: {sgg: sgg},
                    success: function (adminDongs) {

                        $.each(adminDongs, function (index, adminDong) {
                            $('#emdSelect').append(
                                $('<option>', {value: adminDong.emdNm, text: adminDong.emdNm})
                            );
                        });
                    },
                    error: function () {
                        alert('í–‰ì •ë™ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            }
        });

        // ëŒ€ë¶„ë¥˜ í´ë¦­ ì‹œ ê·¸ì— í•´ë‹¹í•˜ëŠ” ì¤‘ë¶„ë¥˜ ë‚˜ì˜¤ëŠ” ì½”ë“œ
        $(".major-item").click(function () {
            const majorCd = $(this).data("majorcd");

            $.ajax({
                url: "getMiddleCategories",   // ğŸ” ì‹¤ì œ ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ë¡œ ìˆ˜ì •
                method: "GET",                  // ë˜ëŠ” "POST"
                data: {majorCd: majorCd},
                success: function (upjongCodes) {
                    // li í•­ëª©ë§Œ ìƒì„±
                    let liHTML = "";

                    upjongCodes.forEach(item => {
                        liHTML += `
                          <li class="middle-item h-12 w-full text-xl font-medium text-center text-black cursor-pointer hover:bg-gray-100"
                              data-middleCd="${item.middleCd}">
                            ${item.middleNm}
                          </li>
                        `;
                    });

                    // ê¸°ì¡´ ul ì•ˆì— li ì¶”ê°€ (ulì€ ìœ ì§€)
                    $(".middleSelector ul").html(liHTML);
                    $(".middleSelector").removeClass('hidden');
                },
                error: function () {
                    alert("ì¤‘ë¶„ë¥˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            });

        });


        // ì¤‘ë¶„ë¥˜ í´ë¦­ ì‹œ ê·¸ì— í•´ë‹¹í•˜ëŠ” ì†Œë¶„ë¥˜ ë‚˜ì˜¤ëŠ” ì½”ë“œ
        $(document).on("click", ".middle-item", function () {
            const middleCd = $(this).data("middlecd");

            $.ajax({
                url: "getMinorCategories",   // ğŸ” ì‹¤ì œ ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ë¡œ ìˆ˜ì •
                method: "GET",                  // ë˜ëŠ” "POST"
                data: {middleCd: middleCd},
                success: function (upjongCodes) {
                    // li í•­ëª©ë§Œ ìƒì„±
                    let liHTML = "";

                    upjongCodes.forEach(item => {
                        liHTML += `
                          <li class="minor-item h-12 w-full text-xl font-medium text-center text-black cursor-pointer hover:bg-gray-100"
                              data-minorCd="${item.minorCd}">
                            ${item.minorNm}
                          </li>
                        `;
                    });

                    // ê¸°ì¡´ ul ì•ˆì— li ì¶”ê°€ (ulì€ ìœ ì§€)
                    $(".minorSelector ul").html(liHTML);
                    $(".minorSelector").removeClass('hidden');
                },
                error: function () {
                    alert("ì†Œë¶„ë¥˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        });

        // ì†Œë¶„ë¥˜ í´ë¦­ ì‹œ
        $(document).on("click", ".minor-item", function () {
            const minorCd = $(this).data("minorcd");

            $.ajax({
                url: "getUpjongCodeByMinorCd",   // ğŸ” ì‹¤ì œ ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ë¡œ ìˆ˜ì •
                method: "GET",                  // ë˜ëŠ” "POST"
                data: {minorCd: minorCd},
                success: function (upjongCode) {

                    $('.upjongInput').val(upjongCode.majorNm + " > " + upjongCode.middleNm + " > " + upjongCode.minorNm);

                    $('.middleSelector').addClass('hidden');
                    $('.minorSelector').addClass('hidden');
                },
                error: function () {
                    alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        });

        // ì—…ì¢… ì…ë ¥ ì‹œ ìë™ì™„ì„± ì½”ë“œ
        $('.upjongInput').on('compositionend', function () {
            const keyword = $(this).val().trim();

            // âœ… ì—¬ê¸°ì„œë„ ê²€ìƒ‰ í˜¸ì¶œ ê°€ëŠ¥
            handleSearch(keyword);


        }).on('keydown', function (e) {
            // keyCode 8 = Backspace, 46 = Delete
            if (e.keyCode === 8 || e.keyCode === 46) {
                setTimeout(() => {
                    const keyword = $(this).val().trim();
                    handleSearch(keyword);
                }, 10);
            }
        });

        // ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œ inputì— ê°’ ì„¤ì •
        $('#autocompleteList').on('click', 'div', function () {
            const selected = $(this).data('value');
            $('.upjongInput').val(selected);
            $('#autocompleteList').empty().addClass('hidden');
        });
    });

    function handleSearch(keyword) {
        if (keyword.length === 0) {
            $('#autocompleteList').empty().addClass('hidden');
            return;
        }

        $.ajax({
            url: 'searchUpjong', // ë°±ì—”ë“œ ì—”ë“œí¬ì¸íŠ¸ì— ë§ê²Œ ìˆ˜ì •
            method: 'GET',
            data: {keyword: keyword},
            success: function (upjongCodeList) {
                console.log(upjongCodeList);
                // if (upjongCodeList.length === 0) {
                //     $('#autocompleteList').empty().addClass('hidden');
                //     return;
                // }
                //
                // let html = '';
                // upjongCodeList.forEach(item => {
                //     html += `<div class="p-2 hover:bg-gray-100 cursor-pointer" data-value="${item}">
                //             ${item}
                //          </div>`;
                // });
                //
                // $('#autocompleteList').html(html).removeClass('hidden');
            },
            error: function () {
                console.log('ì—…ì¢… ê²€ìƒ‰ ì‹¤íŒ¨');
            }
        });
    }

</script>

<style>
    .majorSelector li {
        cursor: pointer;
    }

    .middelSelector li {
        cursor: pointer;
    }

</style>

<!-- ì¹´ì¹´ì˜¤ë§µ -->
<div id="map" style="width: 100%; height: 1000px;"></div>

<!-- ì§€ì—­ ì„ íƒ UI -->
<ul class="flex justify-between items-center w-[450px] h-[47px] overflow-hidden  px-[10px] py-[15px] rounded-[10px] bg-white border border-black absolute left-1/2 -translate-x-1/2 top-[100px]">
    <li class="flex justify-center items-center h-[41px] cursor-pointer">

        <select class="flex justify-center items-center text-[22px] text-center text-black cursor-pointer focus:outline-none focus:ring-0 focus:border-transparent"
                name="sidoSelect"
                id="sidoSelect">
            <option>ì„œìš¸íŠ¹ë³„ì‹œ</option>
        </select>

    </li>
    <li class="flex justify-center items-center h-[41px]  ">
        <select class="flex justify-center items-center text-[22px] text-center text-black cursor-pointer focus:outline-none focus:ring-0 focus:border-transparent"
                name="sggSelect"
                id="sggSelect">
            <option value="">ì‹œ/êµ°/êµ¬</option>
            <option value="ë™êµ¬">ë™êµ¬</option>
            <option value="ì¤‘êµ¬">ì¤‘êµ¬</option>
            <option value="ì„œêµ¬">ì„œêµ¬</option>
            <option value="ìœ ì„±êµ¬">ìœ ì„±êµ¬</option>
            <option value="ëŒ€ë•êµ¬">ëŒ€ë•êµ¬</option>
        </select>
    </li>
    <li class="flex justify-center items-center h-[41px] ">
        <select class="flex justify-center items-center text-[22px] text-center text-black cursor-pointer focus:outline-none focus:ring-0 focus:border-transparent"
                name="emdSelect"
                id="emdSelect">
            <option>í–‰ì •ë™</option>
        </select>
    </li>
</ul>

<!-- ì—…ì¢… ì„ íƒ UI -->
<div class="flex absolute top-[180px] left-[150px] justify-start items-start overflow-hidden gap-2.5 px-[7px] py-1">
    <div
            class="flex flex-col justify-start items-center flex-grow-0 flex-shrink-0 h-[615px] w-[445px] overflow-hidden gap-[31px] pt-[30px] pb-[99px] rounded-[15px] bg-white border border-black"
    >
        <div
                class="flex justify-start items-center self-stretch flex-grow-0 flex-shrink-0 h-[46px] relative overflow-hidden gap-2.5 pl-[30px] pr-[83px]"
        >
            <p
                    class="flex-grow-0 flex-shrink-0 w-[165px] h-[46px] text-xl font-medium text-left text-black"
            >
                ì ìˆ˜ í™•ì¸
            </p>
        </div>
        <div
                class="flex flex-col justify-start items-start flex-grow-0 flex-shrink-0 overflow-hidden gap-5"
        >
            <div
                    class="flex flex-col justify-center items-center flex-grow-0 flex-shrink-0 w-[407px] overflow-hidden gap-2.5 px-[104px] py-2.5"
            >
                <div
                        class="flex justify-between items-center flex-grow-0 flex-shrink-0 w-[381px] h-[41px] relative gap-2.5 px-2.5 py-[7px] rounded-[15px] bg-white border border-black relative"
                >
                    <input placeholder="ì—…ì¢…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"
                           class="upjongInput flex-grow flex-shrink-0  text-xl font-medium text-left focus:outline-none focus:border-none"
                    />

                    <svg
                            width="22"
                            height="22"
                            viewBox="0 0 22 22"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg"
                            class="flex-grow-0 flex-shrink-0 w-[21px] h-[21.5px]"
                            preserveAspectRatio="none"
                    >
                        <circle cx="9" cy="9" r="8.5" transform="matrix(-1 0 0 1 18 0)" stroke="black"></circle>
                        <path d="M15 15.5L21 21.5" stroke="black" stroke-linecap="round"></path>
                    </svg>
                    <div id="autocompleteList"
                         class="border border-gray-300 bg-white absolute z-10 hidden w-full max-h-48 overflow-auto">
                        <!-- ìë™ì™„ì„± ê²°ê³¼ê°€ ì—¬ê¸°ì— ë“¤ì–´ê° -->
                    </div>
                </div>
            </div>
            <div
                    class="majorSelector flex flex-col justify-center items-center flex-grow-0 flex-shrink-0 w-[407px] overflow-hidden gap-[19px]"
            >
                <ul class="flex justify-between items-center self-stretch flex-grow-0 flex-shrink-0 h-[35px] relative overflow-hidden px-[5px]">
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[79.4px] h-[35px] text-[15px] text-center text-black border border-black cursor-pointer"
                        data-majorCd="L1">
                        ë¶€ë™ì‚°
                    </li>
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[79.4px] h-[35px] text-[15px] text-center text-black cursor-pointer"
                        data-majorCd="I1">
                        ìˆ™ë°•
                    </li>
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[79.4px] h-[35px] text-[15px] text-center text-black cursor-pointer"
                        data-majorCd="M1">
                        ê³¼í•™/ê¸°ìˆ 
                    </li>
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[79.4px] h-[35px] text-[15px] text-center text-black cursor-pointer"
                        +
                        data-majorCd="Q1">
                        ë³´ê±´/ì˜ë£Œ
                    </li>
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[79.4px] h-[35px] text-[15px] text-center text-black cursor-pointer"
                        data-majorCd="N1">
                        ê´€ë¦¬/ì„ëŒ€
                    </li>
                </ul>

                <ul class="flex justify-between items-center self-stretch flex-grow-0 flex-shrink-0 h-[35px] relative overflow-hidden">
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[81.4px] h-[35px] text-[15px] text-center text-black cursor-pointer"
                        data-majorCd="G2">
                        ì†Œë§¤
                    </li>
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[81.4px] h-[35px] text-[15px] text-center text-black cursor-pointer"
                        data-majorCd="I2">
                        ìŒì‹
                    </li>
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[81.4px] h-[35px] text-[15px] text-center text-black cursor-pointer"
                        data-majorCd="S2">
                        ìˆ˜ë¦¬
                    </li>
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[81.4px] h-[35px] text-[15px] text-center text-black cursor-pointer"
                        data-majorCd="R1">
                        ì˜ˆì²´ëŠ¥
                    </li>
                    <li class="major-item flex justify-center items-center self-stretch flex-grow w-[81.4px] h-[35px] text-[15px] text-center text-black cursor-pointer"
                        data-majorCd="P1">
                        êµìœ¡
                    </li>
                </ul>

            </div>
        </div>
        <div
                class="flex justify-center items-center flex-grow-0 flex-shrink-0 relative overflow-hidden gap-2.5 px-[115px] py-2.5 rounded-[10px] bg-[#10f] cursor-pointer"
        >
            <p class="flex justify-center items-center flex-grow-0 flex-shrink-0 w-36 h-[38px] text-xl font-medium text-center text-white ">
                í™•ì¸
            </p>
        </div>
        <div
                class="flex flex-col justify-center items-center flex-grow-0 flex-shrink-0 h-[181px] relative overflow-hidden gap-[35px] px-[53px]"
        >
            <p
                    class="flex-grow-0 flex-shrink-0 w-[150px] h-[88px] text-xl font-medium text-center text-black"
            >
        <span
                class="flex-grow-0 flex-shrink-0 w-[150px] h-[88px] text-xl font-medium text-center text-black"
        >í™•ì¸ ì…ë ¥ ì‹œ </span
        ><br/><span
                    class="flex-grow-0 flex-shrink-0 w-[150px] h-[88px] text-xl font-medium text-center text-black"
            >ì ìˆ˜ ëœ¨ëŠ” ê³³</span
            >
            </p>
            <div
                    class="flex justify-center items-center flex-grow-0 flex-shrink-0 w-[205px] h-12 relative overflow-hidden gap-2.5 px-[58px] rounded-[5px] bg-[#10f]"
            >
                <p
                        class="flex-grow-0 flex-shrink-0 w-[102px] h-8 text-xl font-medium text-center text-white cursor-pointer"
                >
                    ìƒì„¸ë³´ê¸°
                </p>
            </div>
        </div>
    </div>
    <div
            class="middleSelector hidden flex justify-center items-center flex-grow-0 flex-shrink-0 w-[386px] h-[200px] gap-2.5 px-[10px] rounded-[15px] bg-white border border-black"
    >
        <ul
                class="flex flex-col justify-start items-center w-full self-stretch flex-grow-0 flex-shrink-0 relative overflow-auto gap-2.5 p-2.5"
        >

        </ul>
    </div>
    <div
            class="minorSelector hidden flex justify-center items-center flex-grow-0 flex-shrink-0 w-[386px] h-[200px] gap-2.5 px-[23px] py-[13px] rounded-[15px] bg-white border border-black"
    >
        <ul
                class="flex flex-col justify-start w-full items-center self-stretch flex-grow-0 flex-shrink-0 relative overflow-auto gap-2.5 p-2.5"
        >
        </ul>
    </div>
</div>
