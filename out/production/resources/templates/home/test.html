<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="common/head::head"></head> <!-- âœ… ê³µë°± ì œê±° -->


<h2>Firebase Social Login</h2>

<button onclick="googleLogin()">êµ¬ê¸€ ë¡œê·¸ì¸</button>
<button onclick="githubLogin()">ê¹ƒí—ˆë¸Œ ë¡œê·¸ì¸</button>

<!-- âœ… ëª¨ë“ˆ ë°©ì‹ìœ¼ë¡œ ìˆ˜ì • -->
<script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
        getAuth,
        GoogleAuthProvider,
        GithubAuthProvider,
        signInWithPopup,
        signInWithRedirect,
        linkWithCredential,
        getRedirectResult
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // âœ… Firebase ì„¤ì •
    const firebaseConfig = {
        apiKey: "AIzaSyDqY-Lj2sJliSi2FOF-nwXf5d99lrlWyMs",
        authDomain: "tmrteamproject.firebaseapp.com",
        projectId: "tmrteamproject",
        storageBucket: "tmrteamproject.firebasestorage.app",
        messagingSenderId: "1042006957683",
        appId: "1:1042006957683:web:7aa5565d3dacc30fda5406",
        measurementId: "G-RE253T3ZQY"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // âœ… Google ë¡œê·¸ì¸
    window.googleLogin = () => {
        const provider = new GoogleAuthProvider();

        // âœ… í•­ìƒ ê³„ì • ì„ íƒ ì°½ì„ ë„ìš°ê¸° ìœ„í•œ ì„¤ì •
        provider.setCustomParameters({
            prompt: 'select_account'
        });

        signInWithPopup(auth, provider)
            .then(result => result.user.getIdToken())
            .then(idToken => sendTokenToServer(idToken))
            .catch(console.error);
    };

    // âœ… í˜ì´ì§€ ì§„ì… ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ê²°ê³¼ ì²˜ë¦¬
    getRedirectResult(auth)
        .then(async (result) => {
            if (result && result.user) {
                console.log("âœ… Google ë¡œê·¸ì¸ ì™„ë£Œ:", result.user.email);

                // ë³‘í•©í•  GitHub credentialì´ ìˆë‹¤ë©´ ë³‘í•©
                if (window.pendingGithubCred) {
                    await linkWithCredential(result.user, window.pendingGithubCred);
                    delete window.pendingGithubCred;
                    console.log("âœ… GitHub ê³„ì • ë³‘í•© ì™„ë£Œ");
                }

                const idToken = await result.user.getIdToken();
                sendTokenToServer(idToken);
            }
        })
        .catch(console.error);

    // âœ… GitHub ë¡œê·¸ì¸
    window.githubLogin = () => {
        const provider = new GithubAuthProvider();
        provider.addScope("user:email");

        signInWithPopup(auth, provider)
            .then(async (result) => {
                const idToken = await result.user.getIdToken();
                sendTokenToServer(idToken);
            })
            .catch(async (error) => {
                if (error.code === "auth/account-exists-with-different-credential") {
                    const email = error.customData?.email;
                    const pendingCred = GithubAuthProvider.credentialFromError(error);

                    alert(`"${email}"ì€ ì´ë¯¸ Google ê³„ì •ìœ¼ë¡œ ê°€ì…ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\nGoogleë¡œ ë¡œê·¸ì¸í•˜ê² ìŠµë‹ˆë‹¤.`);

                    // âœ… ë³‘í•© ì •ë³´ ì „ì—­ ì €ì¥
                    window.pendingGithubCred = pendingCred;

                    // âœ… GitHub íŒì—… ë‹«íˆê³ , Google ë¦¬ë‹¤ì´ë ‰íŠ¸ ë¡œê·¸ì¸ ì‹œë„
                    const googleProvider = new GoogleAuthProvider();
                    googleProvider.setCustomParameters({ prompt: "select_account" });

                    signInWithRedirect(auth, googleProvider);
                } else {
                    console.error("ğŸ”´ ê¸°íƒ€ ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
                    alert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
    };

    // âœ… ì„œë²„ë¡œ í† í° ì „ì†¡
    function sendTokenToServer(idToken) {
        fetch("http://localhost:8080/usr/member/login-check", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ idToken })  // âœ… ì—¬ê¸°ì— idToken ì¶”ê°€
        })
            .then(res => res.text())
            .then(console.log)
            .catch(console.error);
    }
</script>